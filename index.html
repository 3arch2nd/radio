<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <style>
    /* --------------------- ì´ˆê¸° ì„¤ì • ë° ë ˆì´ì•„ì›ƒ --------------------- */
    :root {
      --dark-wood: #4B2F2A; /* ì–´ë‘ìš´ ë‚˜ë¬´ìƒ‰ (í…Œë‘ë¦¬/í”„ë ˆì„) */
      --mid-wood: #6D4C41; /* ì¤‘ê°„ ë‚˜ë¬´ìƒ‰ (ë³¸ì²´ ë°°ê²½) */
      --dial-color: #F5DEB3; /* ë² ì´ì§€ìƒ‰ (ë²„íŠ¼ ë°°ê²½) */
      --panel-bg: #88624E; /* ì£¼íŒŒìˆ˜ íŒ¨ë„ ë°°ê²½ */
      --screen-bg: rgba(255, 255, 255, 0.85);
      --font-color: #333;
      --gowun-dodum: 'Gowun Dodum', sans-serif;
    }

    body {
      font-family: var(--gowun-dodum); 
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column; 
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f4f4f4;
      transition: background-color 0.5s;
    }

    .radio-wrapper {
        position: relative; 
        width: 90vw;
        max-width: 800px;
        height: 60vw;
        max-height: 600px;
        padding-top: 0; 
        box-sizing: content-box; 
    }

    .radio-container {
      width: 100%; 
      height: 100%; 
      background-color: var(--mid-wood); 
      border-radius: 20px;
      box-shadow: 0 0 0 15px var(--dark-wood), 
                  10px 10px 30px rgba(0, 0, 0, 0.5);
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      color: var(--font-color);
      transition: all 0.5s;
      z-index: 10; 
    }
    
    /* --------------------- ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ (ì´ì „ê³¼ ë™ì¼) --------------------- */
    @media (max-width: 768px) {
      .radio-wrapper {
        width: 95vw;
        height: auto; 
      }
      .radio-container {
        padding: 15px;
        box-shadow: 0 0 0 10px var(--dark-wood), 
                    5px 5px 15px rgba(0, 0, 0, 0.5);
        height: auto;
      }
      
      .radio-screen {
          flex-grow: 10; 
          margin-bottom: 10px; 
      }
      
      /* í•˜ë‹¨ ì œì–´ íŒ¨ë„ì„ ìˆ˜ì§(column)ìœ¼ë¡œ ë°°ì¹˜í•˜ì—¬ ìš”ì†Œë“¤ì„ ë¬¶ìŒ */
      .control-panel {
          flex-direction: column;
          padding: 10px;
      }
      
      /* PCìš© ê°œë³„ .dial-controlì€ ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹€ */
      .control-panel > .dial-control {
          display: none; 
      }
      
      /* ëª¨ë°”ì¼ ì „ìš© ë‹¤ì´ì–¼ ë²„íŠ¼ ê·¸ë£¹ í‘œì‹œ (ì‚¬ì—°ì“°ê¸°/ì‚¬ì—°ê´€ë¦¬) */
      .dial-button-group {
          display: flex !important; /* ê°•ì œë¡œ í‘œì‹œ */
          order: 2; /* ë²„íŠ¼ ê·¸ë£¹ì€ ì£¼íŒŒìˆ˜ ì°½ ì•„ë˜ì— ë°°ì¹˜ */
          width: 100%;
          justify-content: space-around;
          margin-bottom: 10px;
      }
      
      /* ëª¨ë°”ì¼ ë‹¤ì´ì–¼ ë²„íŠ¼ ê·¸ë£¹ ë‚´ë¶€ì˜ .dial-controlì€ í‘œì‹œ */
      .dial-button-group .dial-control {
          display: flex; 
          flex-direction: column;
          align-items: center;
          flex: 1; 
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ ë‹¤ì´ì–¼ ë²„íŠ¼ì˜ í¬ê¸° ì¡°ì • */
      .dial-button-group .radio-dial {
          width: 60px; 
          height: 60px;
          font-size: 0.8em;
          margin: 5px auto;
      }
      
      /* 2. ì£¼íŒŒìˆ˜ ì˜ì—­ (ëª¨ë°”ì¼) */
      .frequency-area {
          order: 1; /* ì£¼íŒŒìˆ˜ ì°½ì€ ê°€ì¥ ìœ„ì— ë°°ì¹˜ (ìŠ¤í¬ë¦° ë°”ë¡œ ì•„ë˜) */
          width: 95%;
          padding: 5px 0;
      }
      
      /* 3. QR, HOME, BACK ë²„íŠ¼ ê·¸ë£¹ (ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œ ë°°ì¹˜) */
      .center-buttons {
          order: 3; 
          width: 100%;
          justify-content: space-around;
          margin-top: 10px;
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 5px;
      }
      
      .center-buttons button {
          font-size: 0.65em;
          padding: 8px 5px; 
      }
    }

    /* --------------------- PC ë ˆì´ì•„ì›ƒ (ê¸°ëŠ¥ì„± ìš”ì†Œ) --------------------- */
    
    .radio-screen {
      flex: 1; 
      background-color: var(--screen-bg);
      border-radius: 5px;
      padding: 15px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
      overflow-y: auto;
      position: relative;
      margin-bottom: 20px; 
    }

    .main-content {
      height: 100%;
      width: 100%;
    }

    /* PC: í•˜ë‹¨ ì œì–´ íŒ¨ë„ (3ë¶„í•  ë ˆì´ì•„ì›ƒ ë³µêµ¬) */
    .control-panel {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        background-color: var(--panel-bg); 
        border: 2px solid var(--dark-wood);
        border-radius: 5px;
        padding: 15px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }
    
    /* PC: ë‹¤ì´ì–¼ ì»¨íŠ¸ë¡¤ (ì–‘ìª½ ë²„íŠ¼) - ê¸°ë³¸ì€ í‘œì‹œ */
    .dial-control {
        display: flex; /* PCì—ì„œëŠ” í‘œì‹œ */
        flex-direction: column;
        align-items: center;
        flex-shrink: 0;
        width: 100px; 
        margin: 0 10px;
    }
    
    /* ëª¨ë°”ì¼ì—ì„œ ì‚¬ìš©ëœ ê·¸ë£¹ì€ PCì—ì„œ ìˆ¨ê¹€ */
    .dial-button-group {
        display: none; 
    }
    
    /* ê¸°ëŠ¥ì„± ë²„íŠ¼ (ì‚¬ì—° ì“°ê¸°, ì‚¬ì—° ê´€ë¦¬) */
    .radio-dial {
      width: 70px;
      height: 70px;
      background-color: var(--dial-color);
      border: 4px solid var(--dark-wood);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3), inset 0 0 3px rgba(0, 0, 0, 0.5);
      transition: all 0.1s;
      padding: 5px; 
      box-sizing: border-box;
      line-height: 1.2; 
      font-size: 0.85em; 
    }

    .radio-dial:hover {
      background-color: #fff8e8;
    }
    
    /* ë”ë¯¸ ë‹¤ì´ì–¼ ìŠ¤íƒ€ì¼ */
    .dummy-dial-label {
        font-size: 0.7em;
        color: var(--dial-color);
        margin-top: 5px;
        text-transform: uppercase;
    }

    /* PC: ì¤‘ì•™ ì£¼íŒŒìˆ˜ ì˜ì—­ ë³µêµ¬ */
    .frequency-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 10px;
    }

    .frequency-display-inner {
      position: relative; 
      width: 90%;
      height: 30px;
      background-color: #333;
      border: 1px solid #000;
      border-radius: 3px;
      text-align: center;
      line-height: 30px;
      font-size: 0.9em;
      color: #FFD700; 
      font-family: 'Courier New', monospace; 
      box-shadow: inset 0 0 5px rgba(255, 215, 0, 0.5);
      overflow: hidden;
    }
    
    .center-buttons {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }
    
    /* ì¤‘ì•™ í•˜ë‹¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .center-buttons button {
        padding: 5px 10px;
        background-color: #C0C0C0; 
        border: 1px solid #888;
        border-radius: 3px;
        font-size: 0.7em;
        cursor: pointer;
        font-family: var(--gowun-dodum);
        font-weight: normal; 
    }
    
    /* --------------------- íŒì—…/ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --------------------- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background-color: var(--dial-color);
        border: 8px solid var(--dark-wood);
        border-radius: 15px;
        padding: 30px;
        width: 80%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    .modal-content h3 {
        color: var(--dark-wood);
        font-size: 1.5em;
        border-bottom: 2px dashed var(--panel-bg);
        padding-bottom: 10px;
        margin-top: 0;
    }

    .modal-content p {
        font-size: 1.1em;
        margin: 10px 0;
        line-height: 1.5;
    }

    .modal-content strong {
        color: #d90000; /* PIN/ë¹„ë°€ë²ˆí˜¸ ê°•ì¡° */
        font-size: 1.2em;
        display: block;
        padding: 5px 0;
    }
    
    .modal-button {
        display: block;
        width: 100%;
        padding: 10px;
        margin-top: 20px;
        background-color: var(--dark-wood);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-family: var(--gowun-dodum);
        font-size: 1em;
        transition: background-color 0.1s;
    }

    .modal-button:hover {
        background-color: #331f1d;
    }
    
    /* --------------------- QR ì½”ë“œ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --------------------- */
    #qrCodeContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }
    
    .qr-size {
        width: calc(800px / 9); 
        height: calc(800px / 9);
        max-width: 90px;
        max-height: 90px;
        background-color: white;
        padding: 10px;
        border: 1px solid #333;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }
    
    /* --------------------- í‘¸í„° ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --------------------- */
    .app-footer {
        margin-top: 20px;
        color: #aaaaaa; 
        font-size: 0.8em;
        font-family: var(--gowun-dodum);
    }

    /* --------------------- ê¸°íƒ€ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --------------------- */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--dark-wood); }
    .form-group input[type="text"], .form-group input[type="email"], .form-group input[type="password"], .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: var(--gowun-dodum); }
    .content-title { color: var(--dark-wood); border-bottom: 2px solid var(--dark-wood); padding-bottom: 5px; margin-top: 0; }
    .button-group button { 
        background-color: var(--dark-wood) !important; 
        color: white;
        border: none;
        border-radius: 5px;
        padding: 12px 15px !important;
        margin-right: 0 !important;
        width: 100%;
        text-align: center;
        transition: background-color 0.1s;
    }
    .button-group button:hover { background-color: #331f1d !important; }

    .form-group button[type="submit"] {
        display: block;
        width: 100%; 
        padding: 15px 20px; 
        margin: 20px 0 0 0;
        background-color: var(--dark-wood); 
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1.1em; 
        cursor: pointer;
        font-family: var(--gowun-dodum);
        transition: background-color 0.1s;
    }
    .form-group button[type="submit"]:hover { background-color: #331f1d; }
    
    .story-scroll-container { height: 100%; overflow: hidden; position: relative; padding: 10px; }
    .story-text-scrolling { position: absolute; width: 100%; font-size: 1.2em; color: var(--dark-wood); text-align: center; bottom: -100%; animation: scrollUp 15s linear infinite; }
    @keyframes scrollUp { 0% { transform: translateY(0); } 100% { transform: translateY(-300%); } }
    .story-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    .story-table th, .story-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .story-table th { background-color: #f2f2f2; color: var(--dark-wood); }
    .story-table tr:nth-child(even) { background-color: #f9f9f9; }
    .status-pending { color: orange; font-weight: bold; }
    .status-approved { color: green; font-weight: bold; }
    .status-rejected { color: red; font-weight: bold; }
    .action-btn { padding: 3px 6px; margin: 1px; cursor: pointer; border: none; border-radius: 3px; font-size: 0.8em; }
    .approve-btn { background-color: #4CAF50; color: white; }
    .reject-btn { background-color: #f44336; color: white; }

  </style>
</head>
<body>

  <div class="radio-wrapper">
    <div class="radio-container">
      
      <div class="radio-screen">
        <div class="main-content" id="mainContent">
          <h2 class="content-title">âœ¨ ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ âœ¨</h2>
          <p>í•˜ë‹¨ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!</p>
          <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì œì¶œí•  ìˆ˜ ìˆì–´ìš”.</p>
          <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ë¥¼ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
        </div>
      </div>

      <div class="control-panel">
          
          <div class="dial-control">
              <div class="radio-dial" onclick="loadContent('write')">ì‚¬ì—°<br>ì“°ê¸°</div>
              <div class="dummy-dial-label">VOLUME</div>
          </div>

          <div class="dial-button-group">
            <div class="dial-control">
                <div class="radio-dial" onclick="loadContent('write')">ì‚¬ì—°<br>ì“°ê¸°</div>
                <div class="dummy-dial-label">VOLUME</div>
            </div>
            <div class="dial-control">
                <div class="radio-dial" onclick="loadContent('manage_menu')">ì‚¬ì—°<br>ê´€ë¦¬</div>
                <div class="dummy-dial-label">TUNING</div>
            </div>
          </div>
          
          <div class="frequency-area">
              <div class="frequency-display-inner" id="frequencyDisplay">
                  ğŸ“» ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ - í™˜ì˜í•©ë‹ˆë‹¤!
              </div>
              <div class="center-buttons">
                  <button onclick="showQrCode()">QR CODE</button>
                  <button onclick="loadContent('welcome')">HOME</button>
                  <button onclick="goBack()">BACK</button>
              </div>
          </div>
          
          <div class="dial-control">
              <div class="radio-dial" onclick="loadContent('manage_menu')">ì‚¬ì—°<br>ê´€ë¦¬</div>
              <div class="dummy-dial-label">TUNING</div>
          </div>
      </div>
    </div>
  </div>
  
  <div class="app-footer">
    Copyright Â© 2025 íœ´ë¥´ìŒ¤. All rights reserved.
  </div>

  <div id="resultModalOverlay" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modalTitle">ì±„ë„ ìƒì„± ì™„ë£Œ</h3>
        <p id="modalMessage"></p>
        <p>í•€ ë²ˆí˜¸: <strong id="modalPin"></strong></p>
        <p>ê´€ë¦¬ ë¹„ë°€ë²ˆí˜¸: <strong id="modalPassword"></strong></p>
        <button class="modal-button" onclick="closeModal()">í™•ì¸</button>
    </div>
  </div>


<script>
  // --------------------- í´ë¼ì´ì–¸íŠ¸ JavaScript (ë°”ë‹ë¼ JS) - Cloudflare Worker í†µì‹ ìš© ---------------------
  
  // ğŸ’¡ Cloudflare Workerì˜ URLë¡œ êµì²´í•˜ì„¸ìš”. 
  const WORKER_API_ENDPOINT = 'https://radio.bbglara.workers.dev/'; 
  
  const mainContent = document.getElementById('mainContent');
  const frequencyDisplay = document.getElementById('frequencyDisplay');

  // í˜„ì¬ ì±„ë„ ì •ë³´ ë° ìƒíƒœ ê´€ë¦¬
  let currentChannelPin = null;
  let currentChannelName = null;
  let isStorySubmitted = false;
  let managerPassword = null; 
  
  // íˆìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•  ë°°ì—´ ë° ìµœëŒ€ í¬ê¸° ì„¤ì •
  const pageHistory = [];
  const MAX_HISTORY_SIZE = 5;

  // Worker í†µì‹  í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
  async function callWorker(action, data = {}) {
      try {
          const response = await fetch(WORKER_API_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action, ...data })
          });

          if (!response.ok) {
              const errorBody = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì‘ë‹µ í˜•ì‹' }));
              throw new Error(`HTTP ${response.status}: ${errorBody.message || response.statusText}`);
          }
          return await response.json();
      } catch (error) {
          console.error('Worker í†µì‹  ì‹¤íŒ¨:', error);
          return { success: false, message: `ğŸ› ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${error.message}` };
      }
  }
  
  // --------------------- ë™ì  ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---------------------
  let loadingInterval;

  /**
   * ì£¼íŒŒìˆ˜ ì°½ì— ë™ì  ë¡œë”© ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
   * @param {string} baseMessage - ê¸°ë³¸ ë©”ì‹œì§€ ("PIN ê²€ì¦ ì¤‘" ë“±)
   */
  function startLoadingAnimation(baseMessage) {
      stopLoadingAnimation(); 
      
      let dots = 1;
      const loadingTitle = 'ì¸ì¦/ë¡œë“œ ì¤‘'; 
      
      loadingInterval = setInterval(() => {
          let dotString = '.'.repeat(dots);
          frequencyDisplay.textContent = `ğŸ“» [${loadingTitle}] ${baseMessage}${dotString}`;
          
          dots++;
          if (dots > 3) {
              dots = 1;
          }
      }, 500); // 0.5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
  }

  /**
   * ë™ì  ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ì„ ì¤‘ì§€í•˜ê³ , ì£¼íŒŒìˆ˜ ì°½ì„ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
   */
  function stopLoadingAnimation() {
      if (loadingInterval) {
          clearInterval(loadingInterval);
          loadingInterval = null;
      }
  }

  // --------------------- íŒì—… (ëª¨ë‹¬) ê´€ë¦¬ ê¸°ëŠ¥ (ì´ì „ê³¼ ë™ì¼) ---------------------

  function showModal(title, pin, password) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').innerHTML = 'í•™ìƒ ì ‘ì† ë° ê´€ë¦¬ì ë¡œê·¸ì¸ì„ ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ê¼­ ì €ì¥í•´ ì£¼ì„¸ìš”!';
      document.getElementById('modalPin').textContent = pin;
      document.getElementById('modalPassword').textContent = password;
      document.getElementById('resultModalOverlay').style.display = 'flex';
  }

  function closeModal() {
      document.getElementById('resultModalOverlay').style.display = 'none';
      loadContent('manage_menu'); 
  }


  // --------------------- í˜ì´ì§€ ë¡œë“œ í•¨ìˆ˜ (ìˆ˜ì •ëœ ë¡œë”©/ì •ì§€ ë¡œì§ ë°˜ì˜) ---------------------

  /**
   * ìƒˆë¡œìš´ ì½˜í…ì¸ ë¥¼ ë¡œë“œí•˜ê³  ë‚´ë¶€ íˆìŠ¤í† ë¦¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
   */
  function loadContent(page, skipHistory = false) {
    let html = '';
    
    // ğŸ”‘ ìˆ˜ì •: ìƒˆë¡œìš´ í˜ì´ì§€ ë¡œë“œ ì „ì— ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ì„ ë¬´ì¡°ê±´ ì¤‘ì§€
    stopLoadingAnimation(); 
    
    if (!skipHistory) {
        if (pageHistory.length === 0 || pageHistory[pageHistory.length - 1] !== page) {
             pageHistory.push(page);
             if (pageHistory.length > MAX_HISTORY_SIZE) {
                 pageHistory.shift(); 
             }
        }
       
       history.replaceState({ page: page }, null, `#${page}`);
    }


    if (page === 'welcome') {
        frequencyDisplay.textContent = 'ğŸ“» ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ - í™˜ì˜í•©ë‹ˆë‹¤!';
    } else {
        frequencyDisplay.textContent = `ğŸ“» [${getChannelTitle(page)}] ì±„ë„`;
    }
    
    switch (page) {
      
      case 'welcome':
        html = `
          <h2 class="content-title">âœ¨ ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ âœ¨</h2>
          <p>í•˜ë‹¨ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!</p>
          <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì œì¶œí•  ìˆ˜ ìˆì–´ìš”.</p>
          <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ë¥¼ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
        `;
        break;

      case 'listen':
        if (!currentChannelPin || !currentChannelName) {
            html = `<p style="color: red;">ğŸ¶ ì‚¬ì—° ë“£ê¸°ëŠ” ê´€ë¦¬ì ì±„ë„ ë¡œê·¸ì¸ í›„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ”‘</p>`;
        } else {
            html = `
              <h2 class="content-title">ğŸ¶ [${currentChannelName}] ì‚¬ì—° ë“£ê¸°</h2>
              <div class="button-group">
                <button onclick="playStories('random')">ëœë¤ ì¬ìƒ</button>
                <button onclick="playStories('sequential')">ìˆœì°¨ ì¬ìƒ</button>
              </div>
              <div id="playerArea" style="margin-top: 20px; height: 300px;">
                <p>ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
              </div>
            `;
        }
        break;

      case 'write':
      case 'pin_entry': 
        html = `
          <h2 class="content-title">ğŸ“ ì‚¬ì—° ì“°ê¸°</h2>
          <form id="pinForm">
              <div class="form-group">
                  <label for="pin">ì£¼íŒŒìˆ˜ë¥¼ ë§ì¶°ì£¼ì„¸ìš”! (6ìë¦¬ í•€ë²ˆí˜¸)</label>
                  <input type="text" id="pin" maxlength="6" required>
              </div>
              <button type="submit">ì±„ë„ ì…ì¥</button>
          </form>
          <div id="writeForm" style="display:none;">
            <h3 class="content-title" id="channelNameDisplay"></h3>
            <form id="storyForm">
              <div class="form-group">
                  <label for="storyName">ì´ë¦„ (ìµëª… ê°€ëŠ¥):</label>
                  <input type="text" id="storyName" placeholder="í™ê¸¸ë™" required>
              </div>
              <div class="form-group">
                  <label for="storyContent">ì‚¬ì—° ë‚´ìš©:</label>
                  <textarea id="storyContent" rows="4" placeholder="ì˜¤ëŠ˜ ì¹œêµ¬ì—ê²Œ ê³ ë§ˆì› ë˜ ì¼ì„ ì ì–´ë³´ì•„ìš”."></textarea>
              </div>
              <div class="form-group">
                  <label for="storyUrl">ì›í•˜ëŠ” ìœ íŠœë¸Œ URL ë˜ëŠ” ê³¡ ì œëª©/ì•„í‹°ìŠ¤íŠ¸:</label>
                  <input type="text" id="storyUrl" placeholder="ì˜ˆ: https://youtu.be/..." required>
              </div>
              <button type="submit">ì‚¬ì—° ì œì¶œ</button>
            </form>
            <p id="submissionStatus" style="margin-top: 15px; color: green; font-weight: bold;"></p>
          </div>
        `;
        break;
      
      case 'manage_menu':
        html = `
          <h2 class="content-title">ğŸ”‘ ì‚¬ì—° ê´€ë¦¬í•˜ê¸°</h2>
          <div class="button-group" style="display: flex; flex-direction: column; gap: 15px;">
            <button onclick="loadContent('create_channel')">ìš°ë¦¬ ë°˜ ì±„ë„ ë§Œë“¤ê¸°</button>
            <p style="font-size: 0.8em; margin: 5px 0 15px 0;">ìƒì„±ëœ ì±„ë„ì€ ëª¨ë“  ì‚¬ì—° ì¬ìƒ ì™„ë£Œ í›„ ìì • ìë™ ì‚­ì œë©ë‹ˆë‹¤.</p>
            <button onclick="loadContent('login_manage_stories')">ì‚¬ì—° ê´€ë¦¬ ë° ë“£ê¸°</button>
            <p style="font-size: 0.8em; margin: 5px 0 15px 0;">ë¡œê·¸ì¸ í›„ ì‚¬ì—° ìŠ¹ì¸ ë° ì‚¬ì—° ë“£ê¸°ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          </div>
        `;
        break;
        
      case 'create_channel':
        html = `
          <h2 class="content-title">ğŸ†• ìš°ë¦¬ ë°˜ ì±„ë„ ë§Œë“¤ê¸°</h2>
          <form id="createChannelForm">
            <div class="form-group">
                <label for="channelName">ì±„ë„ëª…:</label>
                <input type="text" id="channelName" required>
            </div>
            <div class="form-group">
                <label for="teacherEmail">êµì‚¬ ì´ë©”ì¼:</label>
                <input type="email" id="teacherEmail" required>
            </div>
            <div class="form-group">
                <label for="teacherPassword">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬):</label>
                <input type="password" id="teacherPassword" maxlength="4" required>
            </div>
            <button type="submit">ì±„ë„ ìƒì„±</button>
          </form>
          <p id="createStatus" style="margin-top: 15px; color: #4682B4; font-weight: bold;"></p>
        `;
        break;
        
      case 'login_manage_stories':
        html = `
          <h2 class="content-title">ğŸ”’ êµì‚¬ ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
          <form id="manageLoginForm">
            <div class="form-group">
                <label for="managerPin">ì±„ë„ PIN ë²ˆí˜¸ (6ìë¦¬):</label>
                <input type="text" id="managerPin" maxlength="6" required>
            </div>
            <div class="form-group">
                <label for="managerPassword">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬):</label>
                <input type="password" id="managerPassword" maxlength="4" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
          </form>
          <p id="manageLoginStatus" style="margin-top: 15px; color: red; font-weight: bold;"></p>
        `;
        break;

      case 'manage_stories':
        html = `<h2 class="content-title">ğŸ—‚ï¸ [${currentChannelName}] ê´€ë¦¬ ë©”ë‰´</h2>
                <div class="button-group" style="margin-bottom: 20px;">
                    <button onclick="loadContent('list_stories')">ì‚¬ì—° ìŠ¹ì¸/ê±°ì ˆ ëª©ë¡</button>
                    <button onclick="loadContent('listen')">ì‚¬ì—° ë“£ê¸° (ëœë¤/ìˆœì°¨)</button>
                </div>
                <div id="storyListArea"><p>ê¸°ëŠ¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p></div>`;
        break;

      case 'list_stories':
        html = `<h2 class="content-title">ğŸ“ [${currentChannelName}] ì‚¬ì—° ëª©ë¡</h2>
                <div id="storyListArea"><p>ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;
        fetchStoriesForManagement(); 
        break;
      
      case 'qrcode':
        html = `
          <h2 class="content-title">ğŸ“± í•™ìƒ ì ‘ì†ìš© QR ì½”ë“œ</h2>
          <p>í•™ìƒë“¤ì—ê²Œ ë³´ì—¬ì£¼ì„¸ìš”! ì´ í˜ì´ì§€ì˜ ì£¼ì†Œë¡œ ì ‘ì†ë©ë‹ˆë‹¤.</p>
          <div id="qrCodeContainer">
              <div id="qrcode" class="qr-size"></div>
          </div>
        `;
        setTimeout(generateQrCode, 100); 
        break;

      default:
        html = `
          <h2 class="content-title">âœ¨ ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ âœ¨</h2>
          <p>í•˜ë‹¨ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!</p>
          <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì œì¶œí•  ìˆ˜ ìˆì–´ìš”.</p>
          <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ë¥¼ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
        `;
        frequencyDisplay.textContent = 'ğŸ“» ìš°ë¦¬ ë°˜ ë¼ë””ì˜¤ - í™˜ì˜í•©ë‹ˆë‹¤!';
    }
    
    mainContent.innerHTML = html;
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    if (page === 'write' || page === 'pin_entry') {
        setupStoryFormListeners();
    } else if (page === 'create_channel') {
        document.getElementById('createChannelForm').addEventListener('submit', handleCreateChannel);
    } else if (page === 'login_manage_stories') {
        document.getElementById('manageLoginForm').addEventListener('submit', handleManageLogin);
    } 
  }

  // --------------------- BACK (ë’¤ë¡œê°€ê¸°) ê¸°ëŠ¥ (ì´ì „ê³¼ ë™ì¼) ---------------------
  function goBack() {
      if (pageHistory.length > 1) {
          pageHistory.pop(); 
          const previousPage = pageHistory[pageHistory.length - 1];
          loadContent(previousPage, true); 
      } else {
          loadContent('welcome', true); 
      }
  }
  
  // --------------------- QR ì½”ë“œ ìƒì„± ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---------------------
  function showQrCode() {
      loadContent('qrcode');
      frequencyDisplay.textContent = 'ğŸ“» [QR CODE] - ì ‘ì† ì£¼íŒŒìˆ˜';
  }

  function generateQrCode() {
      const url = window.location.href.split('#')[0]; 
      const qrcodeElement = document.getElementById('qrcode');
      
      new QRCode(qrcodeElement, {
          text: url,
          width: 90,
          height: 90,
          colorDark : "#000000",
          colorLight : "#ffffff",
          correctLevel : QRCode.CorrectLevel.H
      });
  }

  // --------------------- getChannelTitle í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼) ---------------------
  function getChannelTitle(page) {
    switch (page) {
        case 'listen': return 'ON AIR';
        case 'write': return 'ì‚¬ì—° ì œì¶œ';
        case 'manage_menu': 
        case 'create_channel':
        case 'login_manage_stories':
        case 'manage_stories': 
        case 'list_stories': 
            return 'ê´€ë¦¬ì'; 
        case 'qrcode': return 'QR ì½”ë“œ';
        default: return 'WELCOME';
    }
  }
  
  // --------------------- ì‚¬ì—° ì“°ê¸° - í•€ ë²ˆí˜¸ ê²€ì¦ ë¡œì§ (ìµœì¢… ìˆ˜ì •) ---------------------
  function setupStoryFormListeners() {
    const pinForm = document.getElementById('pinForm');
    const storyFormContainer = document.getElementById('writeForm');
    const storyForm = document.getElementById('storyForm'); // ì‚¬ì—° ì œì¶œ í¼ ìì²´
    
    pinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const pin = document.getElementById('pin').value;
        const channelNameDisplay = document.getElementById('channelNameDisplay');
        const submissionStatus = document.getElementById('submissionStatus');
        
        startLoadingAnimation('PIN ê²€ì¦ ì¤‘');
        submissionStatus.textContent = ''; 
        
        const res = await callWorker('getChannelInfoByPin', { pin });
        
        stopLoadingAnimation(); 

        if (res.success) {
            currentChannelPin = pin;
            currentChannelName = res.channelName;
            
            // ğŸ”‘ ìˆ˜ì • 1: PIN í¼ì„ í™•ì‹¤í•˜ê²Œ ìˆ¨ê¹€
            pinForm.style.display = 'none'; 
            
            // ğŸ”‘ ìˆ˜ì • 2: writeForm ì»¨í…Œì´ë„ˆë¥¼ í™•ì‹¤í•˜ê²Œ í‘œì‹œ
            storyFormContainer.style.display = 'block'; 
            
            loadContent('write'); // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ ë° í˜ì´ì§€ ì œëª© ë³€ê²½

            channelNameDisplay.textContent = `[${currentChannelName}]ì— ì‚¬ì—°ì„ ì œì¶œí•˜ì„¸ìš”!`;
            frequencyDisplay.textContent = `ğŸ“» [${currentChannelName}] ì£¼íŒŒìˆ˜ ì¼ì¹˜! ì‚¬ì—° ì œì¶œ ì¤€ë¹„!`;

            if (isStorySubmitted) {
                // ì´ë¯¸ ì œì¶œí–ˆìœ¼ë©´ ì‚¬ì—° í¼ ìˆ¨ê¸°ê¸°
                storyForm.style.display = 'none';
                submissionStatus.textContent = 'ì‚¬ì—°ì€ í•œ ë²ˆë§Œ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ™';
            } else {
                // ì œì¶œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‚¬ì—° í¼ í‘œì‹œ
                storyForm.style.display = 'block';
                submissionStatus.textContent = '';
            }
        } else {
            submissionStatus.textContent = `ğŸ› ì˜¤ë¥˜: ${res.message}`;
            currentChannelPin = null;
            currentChannelName = null;
        }
    });

    storyForm.addEventListener('submit', handleStorySubmit);
  }

  // --------------------- ì‚¬ì—° ì œì¶œ ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---------------------
  async function handleStorySubmit(e) {
    e.preventDefault();
    if (isStorySubmitted || !currentChannelPin) {
        alert('ì±„ë„ ì¸ì¦ì´ í•„ìš”í•˜ê±°ë‚˜ ì´ë¯¸ ì‚¬ì—°ì„ ì œì¶œí–ˆìŠµë‹ˆë‹¤. ğŸ’¡');
        return;
    }

    const name = document.getElementById('storyName').value;
    const content = document.getElementById('storyContent').value;
    const url = document.getElementById('storyUrl').value;
    const statusDiv = document.getElementById('submissionStatus');
    
    statusDiv.textContent = 'ì œì¶œ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';

    const res = await callWorker('submitStory', { 
        name: name, 
        content: content, 
        youtubeUrl: url,
        pin: currentChannelPin 
    });
    
    if (res.success) {
        statusDiv.textContent = 'âœ… ì‚¬ì—°ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! (ìŠ¹ì¸ ëŒ€ê¸° ì¤‘)';
        isStorySubmitted = true;
        document.getElementById('storyForm').style.display = 'none';
    } else {
        statusDiv.textContent = `ğŸ› ì˜¤ë¥˜ ë°œìƒ: ${res.message}`;
    }
  }
  
  // --------------------- ì±„ë„ ìƒì„± ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---------------------
  async function handleCreateChannel(e) {
      e.preventDefault();
      const channelName = document.getElementById('channelName').value;
      const teacherEmail = document.getElementById('teacherEmail').value;
      const teacherPassword = document.getElementById('teacherPassword').value;
      const createStatus = document.getElementById('createStatus');
      
      const pin = Math.floor(100000 + Math.random() * 900000).toString(); 
      
      startLoadingAnimation('ì±„ë„ ìƒì„± ì¤‘');
      createStatus.textContent = `âœ¨ ì±„ë„ ìƒì„± ì¤‘...`;
      
      const res = await callWorker('createChannel', {
          channelName,
          teacherEmail,
          teacherPassword,
          pin
      });

      stopLoadingAnimation(); 

      if (res.success) {
          showModal(
              `${channelName} ì±„ë„ ìƒì„± ì™„ë£ŒğŸ‰`,
              res.pin, 
              teacherPassword
          );
          createStatus.textContent = ''; // ì›ë˜ ë©”ì‹œì§€ ì˜ì—­ ë¹„ìš°ê¸°
      } else {
          createStatus.textContent = `ğŸ› ì±„ë„ ìƒì„± ì˜¤ë¥˜: ${res.message}`;
      }
  }
  
  // --------------------- êµì‚¬ ê´€ë¦¬ ë¡œê·¸ì¸ ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---------------------
  async function handleManageLogin(e) {
      e.preventDefault();
      const pin = document.getElementById('managerPin').value;
      const password = document.getElementById('managerPassword').value;
      const loginStatus = document.getElementById('manageLoginStatus');
      
      startLoadingAnimation('ë¡œê·¸ì¸ ì¤‘');
      loginStatus.textContent = 'ë¡œê·¸ì¸ ì‹œë„ ì¤‘...';
      
      const authRes = await callWorker('getAllStories', { pin, password }); 
      
      stopLoadingAnimation(); 

      if (authRes.success || authRes.message.includes('ì œì¶œëœ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤')) { 
          
          const channelInfo = await callWorker('getChannelInfoByPin', { pin });
          
          if (channelInfo.success) {
            currentChannelName = channelInfo.channelName;
            currentChannelPin = pin; 
            managerPassword = password; 
            
            loginStatus.textContent = `ë¡œê·¸ì¸ ì„±ê³µ! [${currentChannelName}] ê´€ë¦¬ ë©”ë‰´ë¡œ ì´ë™í•©ë‹ˆë‹¤. ğŸ˜Š`;
            setTimeout(() => {
                loadContent('manage_stories'); 
            }, 500);
          } else {
            loginStatus.textContent = `ì¸ì¦ ì‹¤íŒ¨: ${channelInfo.message}`;
          }

      } else {
          loginStatus.textContent = `ì¸ì¦ ì‹¤íŒ¨: ${authRes.message}`;
      }
  }

  // --------------------- ì‚¬ì—° ê´€ë¦¬ ëª©ë¡ ë° ìŠ¹ì¸ ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---------------------
  async function fetchStoriesForManagement() {
      if (!currentChannelPin || !managerPassword) {
          document.getElementById('storyListArea').innerHTML = '<p style="color: red;">ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>';
          return;
      }
      
      const storyListArea = document.getElementById('storyListArea');
      storyListArea.innerHTML = `<p>ì‚¬ì—° ëª©ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
      
      startLoadingAnimation('ì‚¬ì—° ëª©ë¡ ë¡œë“œ ì¤‘'); 

      const res = await callWorker('getAllStories', { 
          pin: currentChannelPin, 
          password: managerPassword 
      });
      
      stopLoadingAnimation(); 

      if (res.success) {
          const stories = res.stories;
          
          if (stories.length === 0) {
              storyListArea.innerHTML = `<p>ì•„ì§ ì œì¶œëœ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ“</p>`;
              return;
          }
          
          let tableHtml = `<table class="story-table"><thead><tr><th>ë‚ ì§œ</th><th>ì´ë¦„</th><th>ì‚¬ì—° (ì• 15ì)</th><th>URL</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
          
          stories.forEach(story => {
              let statusText = story.status;
              let statusClass;
              
              if (story.isPlayed) {
                  statusClass = 'status-approved';
                  statusText += ' (ì™„ë£Œ)';
              } else {
                  statusClass = `status-${story.status.toLowerCase()}`;
              }
              
              const contentSnippet = story.content.length > 15 ? story.content.substring(0, 15) + '...' : story.content;
              const formattedDate = new Date(story.timestamp).toLocaleDateString('ko-KR');

              tableHtml += `
                  <tr>
                      <td>${formattedDate}</td>
                      <td>${story.name}</td>
                      <td>${contentSnippet}</td>
                      <td><a href="${story.youtubeUrl}" target="_blank">ë§í¬</a></td>
                      <td class="${statusClass}">${statusText}</td>
                      <td>
                          <button class="action-btn approve-btn" onclick="updateStoryStatus(${story.rowNum}, 'Approved')">í™•ì¸</button>
                          <button class="action-btn reject-btn" onclick="updateStoryStatus(${story.rowNum}, 'Rejected')">ê±°ì ˆ</button>
                      </td>
                  </tr>
              `;
          });

          tableHtml += `</tbody></table>`;
          storyListArea.innerHTML = tableHtml;

      } else {
          storyListArea.innerHTML = `<p style="color: red;">ğŸ› ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${res.message}</p>`;
      }
  }
  
  async function updateStoryStatus(rowNum, newStatus) {
      if (!confirm(`í–‰ ë²ˆí˜¸ ${rowNum}ì˜ ì‚¬ì—°ì„ '${newStatus}' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
      }
      
      if (!managerPassword) {
         alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì •ë³´ê°€ ìœ ì‹¤ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
         return;
      }

      const res = await callWorker('updateStoryStatus', {
          rowNum, 
          newStatus, 
          pin: currentChannelPin,
          password: managerPassword 
      });

      if (res.success) {
          alert(res.message);
          fetchStoriesForManagement(); 
      } else {
          alert(`ğŸ› ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${res.message}`);
      }
  }

  // --------------------- ì‚¬ì—° ë“£ê¸° ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ---------------------
  async function playStories(mode) {
      if (!currentChannelPin) {
          alert('ì±„ë„ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
      }
      playMode = mode;
      
      const playerArea = document.getElementById('playerArea');
      playerArea.innerHTML = `<p>ìŠ¹ì¸ë˜ê³  ì•„ì§ ì¬ìƒë˜ì§€ ì•Šì€ ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
      
      startLoadingAnimation('ì‚¬ì—° ë¡œë“œ ì¤‘'); 

      const res = await callWorker('getApprovedStories', { pin: currentChannelPin });
      
      stopLoadingAnimation(); 

      if (res.success) {
          const stories = res.stories; 
          storyData = stories.filter(s => s.youtubeUrl && !s.youtubeUrl.startsWith('Search:'));
          
          if (storyData.length === 0) {
              playerArea.innerHTML = `<p>ë” ì´ìƒ ì½ì„ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤! ğŸ¥³ í•´ë‹¹ ì±„ë„ì€ ë‹¤ìŒ ë‚  ìì • ìë™ ì‚­ì œë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>`; 
              frequencyDisplay.textContent = 'ğŸ“» ëª¨ë“  ì‚¬ì—° ì¬ìƒ ì™„ë£Œ';
              return;
          }

          playerArea.innerHTML = `
              <div id="youtubePlayer" style="height: 250px;"></div>
              <div class="story-scroll-container" style="height: 50px; margin-top: 10px;">
                  <p id="scrollingText" class="story-text-scrolling"></p>
              </div>
          `;
          
          loadYoutubeAPI();
      } else {
          playerArea.innerHTML = `<p style="color: red;">ğŸ› ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${res.message}</p>`;
      }
  }
  
  // (ì´í•˜ Youtube ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼)
  let storyData = [];
  let currentStoryIndex = -1;
  let playMode = 'random';
  let player;


  function loadYoutubeAPI() {
      if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
          const tag = document.createElement('script');
          tag.src = "https://www.youtube.com/iframe_api";
          const firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
      } else {
          onYouTubeIframeAPIReady();
      }
  }


  function onYouTubeIframeAPIReady() {
      if (!player || typeof player.destroy === 'function') {
           player = new YT.Player('youtubePlayer', {
              height: '100%',
              width: '100%',
              events: {
                  'onReady': onPlayerReady,
                  'onStateChange': onPlayerStateChange
              }
          });
      } else {
           playNextStory();
      }
  }

  function onPlayerReady(event) {
      playNextStory();
  }

  function onPlayerStateChange(event) {
      if (event.data === 0) { // ENDED (ì¬ìƒ ì¢…ë£Œ)
          if (currentStoryIndex !== -1 && storyData[currentStoryIndex]) {
              const story = storyData[currentStoryIndex];
              
              callWorker('setStoryPlayed', { 
                  pin: currentChannelPin, 
                  rowNum: story.rowNum 
              })
              .then(res => {
                  if (res.success) {
                      console.log(`[Playback] Row ${story.rowNum} marked as Played.`);
                      storyData.splice(currentStoryIndex, 1);
                      currentStoryIndex = -1; 
                  } else {
                      console.error(`[Playback Error] Failed to mark Row ${story.rowNum} as Played: ${res.message}`);
                  }
                  playNextStory(); 
              });
          } else {
               playNextStory(); 
          }
      }
  }

  function playNextStory() {
      if (storyData.length === 0) {
          const playerArea = document.getElementById('playerArea');
          playerArea.innerHTML = `<p>ë” ì´ìƒ ì½ì„ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤! ğŸ¥³ í•´ë‹¹ ì±„ë„ì€ ë‹¤ìŒ ë‚  ìì • ìë™ ì‚­ì œë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>`;
          frequencyDisplay.textContent = 'ğŸ“» ëª¨ë“  ì‚¬ì—° ì¬ìƒ ì™„ë£Œ';
          if (player) {
             player.stopVideo(); 
          }
          return;
      }
      
      let nextIndex;

      if (playMode === 'random') {
          nextIndex = Math.floor(Math.random() * storyData.length);
      } else { // sequential
          nextIndex = (currentStoryIndex + 1);
          if (nextIndex >= storyData.length) {
              nextIndex = 0;
          }
      }
      
      currentStoryIndex = nextIndex;

      const story = storyData[currentStoryIndex];
      const videoId = getYoutubeVideoId(story.youtubeUrl);
      
      if (videoId && player) {
          player.loadVideoById(videoId);
          
          frequencyDisplay.textContent = `ğŸ¶ ON AIR: ${story.name} ë‹˜ì˜ ì‚¬ì—° (ì±„ë„: ${currentChannelName})`;
          const scrollingText = document.getElementById('scrollingText');
          scrollingText.textContent = `[${story.name} ë‹˜ì˜ ì‚¬ì—°] ${story.content}`;
          scrollingText.style.animation = 'none';
          void scrollingText.offsetWidth; 
          scrollingText.style.animation = 'scrollUp 15s linear infinite';
      } else {
          console.error('ìœ íš¨í•˜ì§€ ì•Šì€ YouTube URL ë˜ëŠ” ID: ', story.youtubeUrl);
          storyData.splice(currentStoryIndex, 1);
          currentStoryIndex = -1; 
          playNextStory(); 
      }
  }

  function getYoutubeVideoId(url) {
      if (!url) return null;
      const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\/|watch\?v=)|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-Z0-9_-]{11})/);
      return (match && match[1]) ? match[1] : null;
  }

  window.onload = () => {
      loadContent('welcome');
  };
</script>
</body>
</html>
