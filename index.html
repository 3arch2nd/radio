<!DOCTYPE html> 
<html>
<head>
  <base target="_top">
<title>ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³ </title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/xgjafB5.png">
    <link rel="shortcut icon" href="https://i.imgur.com/xgjafB5.png">
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <style>
    /* --------------------- ì´ˆê¸° ì„¤ì • ë° ë ˆì´ì•„ì›ƒ --------------------- */
    :root {
      --dark-wood: #4B2F2A; /* ì–´ë‘ìš´ ë‚˜ë¬´ìƒ‰ (í…Œë‘ë¦¬/í”„ë ˆì„) */
      --mid-wood: #6D4C41; /* ì¤‘ê°„ ë‚˜ë¬´ìƒ‰ (ë³¸ì²´ ë°°ê²½) */
      --dial-color: #F5DEB3; /* ë² ì´ì§€ìƒ‰ (ë²„íŠ¼ ë°°ê²½) */
      --panel-bg: #88624E; /* ì£¼íŒŒìˆ˜ íŒ¨ë„ ë°°ê²½ */
      --screen-bg: rgba(255, 255, 255, 0.95);
      --font-color: #333;
      --gowun-dodum: 'Gowun Dodum', sans-serif;
      --error-color: var(--dark-wood);
      /* ìŠ¤í¬ë¡¤ ì§€ì†ì‹œê°„ ë³€ìˆ˜ (ìš”ì²­ ë°˜ì˜: ê¸°ë³¸ 57ì´ˆ) */
      --scrollDur: 57s;
    }

    body {
      font-family: var(--gowun-dodum); 
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column; 
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f4f4f4;
      transition: background-color 0.5s;
    }

    /* ğŸ”‘ í°íŠ¸ ì ìš© ê°•í™”ë¥¼ ìœ„í•œ ì „ì—­ ì„ íƒì */
    h1, h2, h3, p, div, span, button, li, table {
        font-family: var(--gowun-dodum) !important;
    }
    
    .radio-wrapper {
        position: relative; 
        width: 90vw;
        max-width: 800px;
        height: 60vw;
        max-height: 600px;
        padding-top: 0; 
        box-sizing: content-box; 
    }

    .radio-container {
      width: 100%; 
      height: 100%; 
      background-color: var(--mid-wood); 
      border-radius: 20px;
      box-shadow: 0 0 0 15px var(--dark-wood), 
                  10px 10px 30px rgba(0, 0, 0, 0.5);
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      color: var(--font-color);
      transition: all 0.5s;
      z-index: 10; 
    }
    
    /* --------------------- ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸ --------------------- */
    @media (max-width: 768px) {
      .radio-wrapper {
        width: 95vw;
        height: auto; 
      }
      .radio-container {
        padding: 15px;
        box-shadow: 0 0 0 10px var(--dark-wood), 
                    5px 5px 15px rgba(0, 0, 0, 0.5);
        height: auto;
      }
      
      .radio-screen {
          flex-grow: 10; 
          margin-bottom: 10px; 
      }
      
      /* í•˜ë‹¨ ì œì–´ íŒ¨ë„ì„ ìˆ˜ì§(column)ìœ¼ë¡œ ë°°ì¹˜í•˜ì—¬ ìš”ì†Œë“¤ì„ ë¬¶ìŒ */
      .control-panel {
          flex-direction: column;
          padding: 10px;
      }
      
      /* PCìš© ê°œë³„ .dial-controlì€ ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹€ */
      .control-panel > .dial-control {
          display: none; 
      }
      
      /* ëª¨ë°”ì¼ ì „ìš© ë‹¤ì´ì–¼ ë²„íŠ¼ ê·¸ë£¹ í‘œì‹œ (ì‚¬ì—°ì“°ê¸°/ì‚¬ì—°ê´€ë¦¬) */
      .dial-button-group {
          display: flex !important; /* ê°•ì œë¡œ í‘œì‹œ */
          order: 2; /* ë²„íŠ¼ ê·¸ë£¹ì€ ì£¼íŒŒìˆ˜ ì°½ ì•„ë˜ì— ë°°ì¹˜ */
          width: 100%;
          justify-content: space-around;
          margin-bottom: 10px;
      }
      
      /* ëª¨ë°”ì¼ ë‹¤ì´ì–¼ ë²„íŠ¼ ê·¸ë£¹ ë‚´ë¶€ì˜ .dial-controlì€ í‘œì‹œ */
      .dial-button-group .dial-control {
          display: flex; 
          flex-direction: column;
          align-items: center;
          flex: 1; 
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ ë‹¤ì´ì–¼ ë²„íŠ¼ì˜ í¬ê¸° ì¡°ì • */
      .dial-button-group .radio-dial {
          width: 60px; 
          height: 60px;
          font-size: 0.8em;
          margin: 5px auto;
      }
      
      /* 2. ì£¼íŒŒìˆ˜ ì˜ì—­ (ëª¨ë°”ì¼) */
      .frequency-area {
          order: 1; /* ì£¼íŒŒìˆ˜ ì°½ì€ ê°€ì¥ ìœ„ì— ë°°ì¹˜ (ìŠ¤í¬ë¦° ë°”ë¡œ ì•„ë˜) */
          width: 95%;
          padding: 5px 0;
      }
      
      /* 3. QR, HOME, BACK ë²„íŠ¼ ê·¸ë£¹ (ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œ ë°°ì¹˜) */
      .center-buttons {
          order: 3; 
          width: 100%;
          justify-content: space-around;
          margin-top: 10px;
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 5px;
      }
      
      .center-buttons button {
          font-size: 0.65em;
          padding: 8px 5px; 
      }
      
      /* ëª¨ë°”ì¼ ì‚¬ì—° ë“£ê¸° í™”ë©´ ì¡°ì •: ìˆ˜ì§ìœ¼ë¡œ ìŒ“ê¸° */
      .story-player-area {
          flex-direction: column;
          height: 100%;
      }
      .scroll-text-box {
          width: 100%;
          border-right: none; 
          padding-bottom: 15px; 
      }
      .youtube-panel {
          width: 100%;
          min-height: 250px; 
      }
      .youtube-box {
          height: auto; 
          padding: 0;
      }

      /* ëª¨ë°”ì¼ ê´€ë¦¬ì ë©”ë‰´ ìˆ˜ì§ ì •ë ¬ ë³µêµ¬ */
      .main-content .menu-wrapper {
          flex-direction: column;
          gap: 10px;
      }
      .main-content .menu-item-wrapper {
          width: 100%;
          margin: 5px 0;
      }
      .main-content .menu-item-wrapper > p {
          text-align: left;
      }
    }

    /* --------------------- PC ë ˆì´ì•„ì›ƒ (ê¸°ëŠ¥ì„± ìš”ì†Œ) --------------------- */
    
    .radio-screen {
      flex: 1; 
      background-color: var(--screen-bg);
      border-radius: 5px;
      overflow-y: auto; 
      position: relative;
      margin-bottom: 20px; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      padding: 15px; 
    }

    .main-content {
      flex-grow: 1; 
      width: 100%;
      display: flex; 
      flex-direction: column;
      min-height: 0; 
    }
    
    /* ğŸ”‘ ë©”ì¸ í˜ì´ì§€ ì œëª© ì•„ë˜ êµ¬ë¶„ì„  */
    .main-content h2 {
        border-bottom: 2px solid var(--panel-bg);
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    /* ğŸ”‘ ê´€ë¦¬ì ë©”ë‰´ ìˆ˜í‰ ì •ë ¬ */
    .main-content .menu-wrapper {
        display: flex;
        justify-content: space-around;
        gap: 20px; /* í•­ëª© ì‚¬ì´ ê°„ê²© */
        width: 100%;
        margin-top: 15px;
    }
    
    /* ğŸ”‘ ë²„íŠ¼ê³¼ ì„¤ëª… ë˜í¼ */
    .main-content .menu-item-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1 1 30%; 
        min-width: 180px; 
        text-align: center;
        margin: 0;
    }
    .main-content .menu-item-wrapper > button {
        width: 100%;
        max-width: 250px;
        padding: 15px 20px !important; 
        margin-bottom: 5px;
        font-size: 1.1em !important;
        font-weight: bold;
    }
    .main-content .menu-item-wrapper > p {
        font-size: 0.85em;
        margin: 0;
        line-height: 1.3;
    }
    
    /* --------------------- ì‚¬ì—° ë“£ê¸° í™”ë©´ ë¶„í•  --------------------- */
    .story-player-area {
        display: flex;
        flex-grow: 1; 
        width: 100%;
        min-height: 300px;
    }
    
    /* ì™¼ìª½ 3/5 ì˜ì—­ */
    .scroll-text-box {
        flex: 3;
        overflow-y: hidden; 
        position: relative;
        padding: 10px;
        padding-right: 20px; 
        padding-left: 5px; 
        border-right: 1px solid #ccc; 
        height: 100%; 
        display: flex; 
        flex-direction: column;
    }
    
    /* ğŸ”‘ ìŠ¤í¬ë¡¤ í…ìŠ¤íŠ¸: í°íŠ¸í¬ê¸° !important ì œê±° + ì™¼ìª½ìœ¼ë¡œ 10px ì´ë™ + ì¤„ë°”ê¿ˆ í—ˆìš© + ì§€ì†ì‹œê°„ ë³€ìˆ˜ ì‚¬ìš© */
    .story-text-scrolling { 
        position: absolute; 
        width: 100%; 
        color: var(--dark-wood); 
        text-align: center; 
        top: 100%; 
        left: -10px;              /* âœ… ìš”ì²­: ì™¼ìª½ìœ¼ë¡œ 10px ì´ë™ */
        padding: 0 10px; 
        white-space: pre-wrap;    /* âœ… ìš”ì²­: ì¤„ë°”ê¿ˆ ì²˜ë¦¬ */
        animation: scrollUp var(--scrollDur) linear forwards; 
    }

    /* ê¸€ì”¨ í¬ê¸° í† ê¸€ìš© í´ë˜ìŠ¤ */
    .size-small{ font-size: 1.2em; }   /* âœ… a(ê¸°ë³¸) */
    .size-large{ font-size: 2.4em; }   /* âœ… A(í˜„ì¬ì™€ ë™ì¼) */

    @keyframes scrollUp {
        0% { transform: translateY(0); }
        100% { transform: translateY(-2000px); } 
    }

    /* í…ìŠ¤íŠ¸ ë°•ìŠ¤ ì•ˆì˜ ì œëª©ê³¼ ì•ˆë‚´ ë¬¸êµ¬ ë†’ì´ ê³ ì • */
    .scroll-text-box h2,
    .scroll-text-box p#playerArea {
        flex-shrink: 0;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    .story-scroll-container {
        flex-grow: 1;
        overflow: hidden; 
        position: relative; 
        padding: 10px 0; 
    }

    /* ì˜¤ë¥¸ìª½ 2/5 ì˜ì—­ */
    .youtube-panel {
        flex: 2;
        display: flex;
        flex-direction: column; 
        padding: 10px;
        height: 100%;
    }
    
    /* ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ */
    .playback-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    /* ì¬ìƒ/ëœë¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .icon-button {
        background-color: var(--dark-wood);
        color: var(--dial-color);
        border: 2px solid var(--panel-bg);
        border-radius: 5px;
        width: 40px;
        height: 40px;
        font-size: 1.5em;
        line-height: 1;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.1s;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .icon-button:hover {
        background-color: #331f1d;
    }
    .icon-button[title="ëœë¤ ì¬ìƒ"] {
        font-family: Arial, sans-serif !important; 
    }

    /* í•˜ë‹¨ ìœ íŠœë¸Œ ì˜ì—­ */
    .youtube-box {
        position: relative; 
        flex-grow: 1; 
        display: flex;
        justify-content: center;
        align-items: flex-end; 
        width: 100%;
        min-height: 150px; 
        transition: opacity 0.3s;
    }
    #youtubePlayer {
        width: 100%;
        height: 150px;
        max-height: 100%;
        z-index: 1; 
    }
    
    /* ----- ê¸€ì”¨ í¬ê¸° í† ê¸€ ë²„íŠ¼ (a / A) ----- */
    .font-toggle {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      margin-left: 12px;
    }
    .font-btn{
      min-width: 36px;
      height: 36px;
      border: 2px solid var(--panel-bg);
      border-radius: 5px;
      background: #fff;                 /* ê¸°ë³¸ í°ìƒ‰ */
      color: var(--dark-wood);
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 8px;
      transition: background-color .15s ease, transform .05s ease;
    }
    .font-btn:active{ transform: scale(0.98); }
    .font-btn.active{
      background: var(--dial-color);     /* âœ… í™œì„± ì‹œ ì—°ë…¸ë‘ */
      /* í…Œë‘ë¦¬ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ */
    }

    /* --------------------- í¼ ì…ë ¥ í•„ë“œ --------------------- */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--dark-wood); }
    
    .form-group input[type="text"], 
    .form-group input[type="email"], 
    .form-group input[type="password"], 
    .form-group textarea,
    .status-select { 
      width: 100%; 
      padding: 8px; 
      font-family: var(--gowun-dodum) !important; 
      background-color: var(--dial-color);
      color: var(--dark-wood);
      border: 2px solid var(--panel-bg);
      border-radius: 4px; 
      box-sizing: border-box; 
    }
    
    /* --------------------- ì¤‘ì•™ í•˜ë‹¨ ë²„íŠ¼ (QR, HOME, BACK) --------------------- */
    .center-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .center-buttons button {
        padding: 5px 10px;
        background-color: var(--dial-color); 
        color: var(--dark-wood);
        border: 2px solid var(--panel-bg); 
        border-radius: 5px; 
        font-size: 0.7em;
        font-family: var(--gowun-dodum) !important; 
        font-weight: bold; 
    }
    
    /* --------------------- QR ì½”ë“œ --------------------- */
    .qr-size {
        width: 135px !important; 
        height: 135px !important;
        max-width: 135px;
        max-height: 135px;
        background-color: white;
        padding: 10px;
        border: 1px solid #333;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }
    
    /* --------------------- íŒì—… (fixed) --------------------- */
    .modal-overlay {
        position: fixed !important; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-overlay.show { display: flex !important; }

    .modal-content {
        background-color: var(--screen-bg);
        border: 8px solid var(--dark-wood);
        border-radius: 15px;
        padding: 30px;
        width: 80%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        font-family: var(--gowun-dodum) !important; 
    }
    .modal-content h3 {
        color: var(--dark-wood);
        font-size: 1.5em;
        border-bottom: 2px dashed var(--panel-bg);
        padding-bottom: 10px;
        margin-top: 0;
    }
    .modal-content strong {
        color: #d90000; 
        font-size: 1.2em;
        display: block;
        padding: 5px 0;
        font-family: var(--gowun-dodum) !important; 
    }
    
    /* --------------------- ê¸°íƒ€ ìŠ¤íƒ€ì¼ --------------------- */
    .control-panel {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        background-color: var(--panel-bg); 
        border: 2px solid var(--dark-wood);
        border-radius: 5px;
        padding: 15px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }
    .dial-control {
        display: flex; 
        flex-direction: column;
        align-items: center;
        flex-shrink: 0;
        width: 100px; 
        margin: 0 10px;
    }
    .dial-button-group { display: none; }
    .radio-dial {
      width: 70px;
      height: 70px;
      background-color: var(--dial-color);
      border: 4px solid var(--dark-wood);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3), inset 0 0 3px rgba(0, 0, 0, 0.5);
      transition: all 0.1s;
      padding: 5px; 
      box-sizing: border-box;
      line-height: 1.2; 
      font-size: 0.85em; 
    }
    .radio-dial:hover { background-color: #fff8e8; }
    .dummy-dial-label {
        font-size: 0.7em;
        color: var(--dial-color);
        margin-top: 5px;
        text-transform: uppercase;
    }

    .frequency-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 10px;
    }
    .frequency-display-inner {
      position: relative; 
      width: 90%;
      height: 30px;
      background-color: #333;
      border: 1px solid #000;
      border-radius: 3px;
      text-align: center;
      line-height: 30px;
      font-size: 0.9em;
      color: #FFD700; 
      font-family: 'Courier New', monospace !important; 
      box-shadow: inset 0 0 5px rgba(255, 215, 0, 0.5);
      overflow: hidden;
    }

    .app-footer {
        margin-top: 20px;
        color: #aaaaaa; 
        font-size: 0.8em;
        font-family: var(--gowun-dodum);
    }

    .story-table { 
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85em;
        border: 1px solid #ddd;
    }
    .story-table th, .story-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        font-family: var(--gowun-dodum) !important; 
    }
    .story-table td[title] { cursor: help; }

    .button-group button { 
        background-color: var(--dark-wood) !important; 
        color: white;
        border: none;
        border-radius: 5px;
        padding: 12px 15px !important;
        margin-right: 0 !important;
        width: 100%;
        text-align: center;
        transition: background-color 0.1s;
    }

/* ===== ê´€ë¦¬ í™”ë©´ ìƒíƒœ ì»¬ëŸ¬ & ê¸€ë¡œìš° ===== */
.story-table td[class^="status-"]{
  font-weight: 700;
  text-align: center;
  border-left: 4px solid transparent;
  transition: background-color .2s ease, box-shadow .2s ease, color .2s ease;
}

/* Approved = ì´ˆë¡ */
.story-table td.status-approved{
  color: #0f5132;                                 /* ê¸€ììƒ‰ */
  text-shadow: 0 0 6px rgba(25,135,84,0.45);      /* ê¸€ì ê¸€ë¡œìš° */
}

/* Pending = ë…¸ë‘ */
.story-table td.status-pending{
  color: #664d03;
  text-shadow: 0 0 6px rgba(255,193,7,0.5);
}

/* Rejected = ë¹¨ê°• */
.story-table td.status-rejected{
  color: #842029;
  text-shadow: 0 0 6px rgba(220,53,69,0.45);
}

  </style>
</head>
<body>

  <div class="radio-wrapper">
    <div class="radio-container">
      
      <div class="radio-screen" id="radioScreen">
        <div class="main-content" id="mainContent">
            <h2 class="content-title">ğŸ“» ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  ğŸ’Œ</h2>
            <p>ì•„ë˜ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”!</p>
            <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì‹ ì²­ê³¡ê³¼ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.</p>
            <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ë¼ë””ì˜¤ë¥¼ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
        </div>
      </div>

      <div class="control-panel">
          
          <div class="dial-control">
              <div class="radio-dial" onclick="loadContent('write')">ì‚¬ì—°<br>ì“°ê¸°</div>
              <div class="dummy-dial-label">VOLUME</div>
          </div>

          <div class="dial-button-group">
            <div class="dial-control">
                <div class="radio-dial" onclick="loadContent('write')">ì‚¬ì—°<br>ì“°ê¸°</div>
                <div class="dummy-dial-label">VOLUME</div>
            </div>
            <div class="dial-control">
                <div class="radio-dial" onclick="loadContent('manage_menu')">ì‚¬ì—°<br>ê´€ë¦¬</div>
                <div class="dummy-dial-label">TUNING</div>
            </div>
          </div>
          
          <div class="frequency-area">
              <div class="frequency-display-inner" id="frequencyDisplay">
                  ğŸ“» ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  - í™˜ì˜í•©ë‹ˆë‹¤!
              </div>
              <div class="center-buttons">
                  <button onclick="showQrCode()">QR CODE</button>
                  <button onclick="loadContent('welcome')">HOME</button>
                  <button onclick="goBack()">BACK</button>
              </div>
          </div>
          
          <div class="dial-control">
              <div class="radio-dial" onclick="loadContent('manage_menu')">ì‚¬ì—°<br>ê´€ë¦¬</div>
              <div class="dummy-dial-label">TUNING</div>
          </div>
      </div>
    </div>
  </div>
  
  <div class="app-footer">
    Copyright Â© 2025 3arch2nd. All rights reserved.
  </div>

  <div id="resultModalOverlay" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modalTitle">ì±„ë„ ìƒì„± ì™„ë£Œ</h3>
        <p id="modalMessage"></p>
        <p>í•€ ë²ˆí˜¸: <strong id="modalPin"></strong></p>
        <p>ê´€ë¦¬ ë¹„ë°€ë²ˆí˜¸: <strong id="modalPassword"></strong></p>
        <button class="modal-button" onclick="closeModal()">í™•ì¸</button>
    </div>
  </div>


<script>
  // --------------------- í´ë¼ì´ì–¸íŠ¸ JavaScript (ë°”ë‹ë¼ JS) - Cloudflare Worker í†µì‹ ìš© ---------------------
  
  // ğŸ’¡ Cloudflare Workerì˜ URLë¡œ êµì²´í•˜ì„¸ìš”. 
  const WORKER_API_ENDPOINT = 'https://radio.bbglara.workers.dev/'; 
  
  const mainContent = document.getElementById('mainContent'); 
  const frequencyDisplay = document.getElementById('frequencyDisplay');
  const radioScreen = document.getElementById('radioScreen'); // radio-screen ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

  // í˜„ì¬ ì±„ë„ ì •ë³´ ë° ìƒíƒœ ê´€ë¦¬
  let currentChannelPin = null;
  let currentChannelName = null;
  let isStorySubmitted = false;
  let managerPassword = null; 
  
  // íˆìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•  ë°°ì—´ ë° ìµœëŒ€ í¬ê¸° ì„¤ì •
  const pageHistory = [];
  const MAX_HISTORY_SIZE = 5;

  // ===== ê¸€ì”¨ í¬ê¸° í† ê¸€ ìƒíƒœ (ê¸°ë³¸ a) =====
  let textSizeMode = 'small';

  // Worker í†µì‹  í•¨ìˆ˜
  async function callWorker(action, data = {}) {
      try {
          const response = await fetch(WORKER_API_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action, ...data })
          });

          if (!response.ok) {
              const errorBody = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì‘ë‹µ í˜•ì‹' }));
              throw new Error(`HTTP ${response.status}: ${errorBody.message || response.statusText}`);
          }
          return await response.json();
      } catch (error) {
          console.error('Worker í†µì‹  ì‹¤íŒ¨:', error);
          return { success: false, message: `ğŸ› ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${error.message}` };
      }
  }
  
  // --------------------- ë™ì  ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ---------------------
  let loadingInterval;

  function startLoadingAnimation(baseMessage) {
      stopLoadingAnimation(); 
      
      let dots = 1;
      const loadingTitle = 'loading';
      
      loadingInterval = setInterval(() => {
          let dotString = '.'.repeat(dots);
          frequencyDisplay.textContent = `[${loadingTitle}] ${baseMessage}${dotString}`;
          
          dots++;
          if (dots > 3) {
              dots = 1;
          }
      }, 500);
  }

  function stopLoadingAnimation() {
      if (loadingInterval) {
          clearInterval(loadingInterval);
          loadingInterval = null;
      }
  }

  // --------------------- íŒì—… (ëª¨ë‹¬) ---------------------
  function showModal(title, pin, password) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').innerHTML = 'í•™ìƒ ì ‘ì† ë° ê´€ë¦¬ì ë¡œê·¸ì¸ì„ ìœ„í•´<br>ë‹¤ìŒ ì •ë³´ë¥¼ ê¼­ ì €ì¥í•´ ì£¼ì„¸ìš”!';
      document.getElementById('modalPin').textContent = pin;
      document.getElementById('modalPassword').textContent = password;
      document.getElementById('resultModalOverlay').classList.add('show');
  }
  function closeModal() {
      document.getElementById('resultModalOverlay').classList.remove('show');
      loadContent('manage_menu'); 
  }

  // --------------------- ê¸€ì”¨ í¬ê¸° í† ê¸€ ë¡œì§ ---------------------
  function initFontToggleListeners(){
    const sm = document.getElementById('fontSmallBtn');
    const lg = document.getElementById('fontLargeBtn');
    if(!sm || !lg) return;
    // ê¸°ë³¸ í™œì„± í‘œì‹œ (a)
    sm.classList.add('active');

    sm.onclick = () => setTextSize('small');
    lg.onclick = () => setTextSize('large');
  }

  function setTextSize(mode){
    textSizeMode = (mode === 'large') ? 'large' : 'small';
    const sm = document.getElementById('fontSmallBtn');
    const lg = document.getElementById('fontLargeBtn');
    if(sm && lg){
      sm.classList.toggle('active', textSizeMode==='small');
      lg.classList.toggle('active', textSizeMode==='large');
    }
    applyTextSize(true); // ìŠ¤í¬ë¡¤ ì§„í–‰ ì¤‘ì—ë„ ìµœëŒ€í•œ ìì—°ìŠ¤ëŸ½ê²Œ ìœ ì§€
  }

  function applyTextSize(preserveProgress){
    const el = document.getElementById('scrollingText');
    if(!el) return;

    // í˜„ì¬ ì§„í–‰ ì‹œê°„ ì¶”ì •(Web Animations API)
    let elapsed = 0; // ì´ˆ
    if (preserveProgress && el.getAnimations) {
      const anim = el.getAnimations()[0];
      if (anim && typeof anim.currentTime === 'number') {
        elapsed = anim.currentTime / 1000;
      }
    }

    // í¬ê¸° í´ë˜ìŠ¤ ì ìš©
    el.classList.remove('size-small','size-large');
    el.classList.add(textSizeMode === 'large' ? 'size-large' : 'size-small');

    // ì• ë‹ˆë©”ì´ì…˜ì„ ë™ì¼ ì§„í–‰ë„ë¡œ ì¬ê°œ(ìŒìˆ˜ delay í™œìš©)
    const dur = getComputedStyle(el).getPropertyValue('--scrollDur') || '57s';
    el.style.animation = 'none';
    void el.offsetWidth; // reflow
    el.style.animation = `scrollUp ${dur.trim()} linear forwards`;
    el.style.animationDelay = (elapsed > 0) ? `${-elapsed}s` : '0s';
  }

  // --------------------- í˜ì´ì§€ ë¡œë“œ í•¨ìˆ˜ ---------------------
  function loadContent(page, skipHistory = false) {
    let html = '';
    
    stopLoadingAnimation(); 
    
    if (!skipHistory) {
        if (pageHistory.length === 0 || pageHistory[pageHistory.length - 1] !== page) {
             pageHistory.push(page);
             if (pageHistory.length > MAX_HISTORY_SIZE) pageHistory.shift(); 
        }
        history.replaceState({ page: page }, null, `#${page}`);
    }

    if (page === 'welcome') {
        frequencyDisplay.textContent = 'ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  - í™˜ì˜í•©ë‹ˆë‹¤!';
    } else {
        frequencyDisplay.textContent = `[${getChannelTitle(page)}] ì±„ë„`;
    }
    
    radioScreen.style.flexDirection = 'column'; 
    
    switch (page) {
      case 'welcome':
        html = `
          <h2 class="content-title">ğŸ“» ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  ğŸ’Œ</h2>
          <p>í•˜ë‹¨ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”!</p>
          <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì‹ ì²­ê³¡ê³¼ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.</p>
          <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”. (ê´€ë¦¬ì í˜ì´ì§€)</p>
        `;
        break;

      case 'listen':
        if (!currentChannelPin || !currentChannelName) {
            html = `<p style="color: red;">ğŸ¶ ì‚¬ì—° ë“£ê¸°ëŠ” ê´€ë¦¬ì ì±„ë„ ë¡œê·¸ì¸ í›„ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ”‘</p>`;
        } else {
            html = `
              <div class="story-player-area">
                <div class="scroll-text-box">
                    <h2 class="content-title">ğŸ¶ ì‚¬ì—° ë“£ê¸°</h2> 
                    <p id="playerArea" style="margin-top: 10px;">ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                    <div class="story-scroll-container">
                        <p id="scrollingText" class="story-text-scrolling size-small"></p>
                    </div>
                </div>
                
                <div class="youtube-panel">
                    <div class="playback-controls">
                        <button class="icon-button" title="ìˆœì°¨ ì¬ìƒ" onclick="playStories('sequential')">&#9654;</button>
                        <button class="icon-button" title="ëœë¤ ì¬ìƒ" onclick="playStories('random')">&#8644;</button>

                        <!-- âœ… ê¸€ì”¨ í¬ê¸° í† ê¸€ -->
                        <div class="font-toggle">
                          <button id="fontSmallBtn" class="font-btn">a</button>
                          <button id="fontLargeBtn" class="font-btn">A</button>
                        </div>
                    </div>

                    <div id="currentStoryInfo"></div>

                    <div class="youtube-box">
                        <div id="youtubePlayer"></div>
                    </div>
                </div>
              </div>
            `;
        }
        break;

      case 'write':
      case 'pin_entry': 
        html = `
          <h2 class="content-title">ğŸ“ ì‚¬ì—° ì“°ê¸°</h2>
          <form id="pinForm">
              <div class="form-group">
                  <label for="pin">ì£¼íŒŒìˆ˜ë¥¼ ë§ì¶°ì£¼ì„¸ìš”! (6ìë¦¬ í•€ë²ˆí˜¸)</label>
                  <input type="text" id="pin" maxlength="6" required>
              </div>
              <button type="submit">ì±„ë„ ì…ì¥</button>
          </form>
          <div id="writeForm" style="display:none;">
            <h3 class="content-title" id="channelNameDisplay"></h3>
            <form id="storyForm">
              <div class="form-group">
                  <label for="storyName">ì´ë¦„:</label>
                  <input type="text" id="storyName" placeholder="í™ê¸¸ë™" required>
              </div>
              <div class="form-group">
                  <label for="storyContent">ì‚¬ì—° ë‚´ìš©:</label>
                  <textarea id="storyContent" rows="4" placeholder="ë³´ë‚´ê³  ì‹¶ì€ ë§ˆìŒì„ ë‹´ì•„ ì£¼ì„¸ìš”."></textarea>
              </div>
              
              <div class="form-group" style="border-bottom: 1px solid #ddd; padding-bottom: 15px;">
                  <label for="searchQuery">ì›í•˜ëŠ” ê³¡ ê²€ìƒ‰ (ê°€ìˆ˜, ì œëª© ìˆœìœ¼ë¡œ ì“°ê¸°):</label> 
                  <input type="text" id="searchQuery" placeholder="ì˜ˆ: ìœ¤í•˜, ì‚¬ê±´ì˜ ì§€í‰ì„ " style="margin-bottom: 5px;"> 
                  <button type="button" onclick="handleSearch()" style="padding: 8px; font-size: 0.9em; background-color: var(--panel-bg); color: white;">ê³¡ ê²€ìƒ‰</button>
                  <ul id="searchResults"></ul>
              </div>
              
              <div class="form-group">
                  <label for="storyUrl">ì„ íƒëœ ìœ íŠœë¸Œ URL (ë˜ëŠ” ì§ì ‘ ì…ë ¥):</label>
                  <input type="text" id="storyUrl" placeholder="ì„ íƒ í›„ ìë™ ì…ë ¥ë©ë‹ˆë‹¤." required>
              </div>

              <button type="submit">ì‚¬ì—° ë³´ë‚´ê¸°</button>
            </form>
            <p id="submissionStatus" style="margin-top: 15px; color: var(--error-color); font-weight: bold;"></p>
          </div>
        `;
        break;
      
      case 'manage_menu':
        html = `
          <h2 class="content-title">ğŸ”‘ ê´€ë¦¬ì ë©”ë‰´</h2>
          <div class="menu-wrapper">
            <div class="menu-item-wrapper">
                <button onclick="loadContent('create_channel')">ì±„ë„ ë§Œë“¤ê¸°</button>
                <p>ìƒì„±ëœ ì±„ë„ì€ ëª¨ë“  ì‚¬ì—°ì´ ì¬ìƒë˜ë©´ <br> ìì •ì— ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
            </div>
            <div class="menu-item-wrapper">
                <button onclick="loadContent('login_manage_stories')">ì‚¬ì—° ê´€ë¦¬ (ìŠ¹ì¸/ê±°ì ˆ)</button>
                <p>ë¡œê·¸ì¸ í›„ ë„ì°©í•œ ì‚¬ì—°ì„ <br> ìŠ¹ì¸/ê±°ì ˆí•©ë‹ˆë‹¤.</p>
            </div>
            <div class="menu-item-wrapper">
                <button onclick="loadContent('login_listen')">ì‚¬ì—° ë“£ê¸° (ì±„ë„ ì—°ê²°)</button>
                <p>ë¡œê·¸ì¸ í›„ ìŠ¹ì¸ëœ ì‚¬ì—°ì„ <br> ìˆœì°¨/ëœë¤ ì¬ìƒí•©ë‹ˆë‹¤.</p>
            </div>
          </div>
        `;
        break;
        
      case 'create_channel':
        html = `
          <h2 class="content-title">ğŸ› ï¸ ìƒˆ ì±„ë„ ë§Œë“¤ê¸°</h2>
          <form id="createChannelForm">
            <div class="form-group">
                <label for="channelName">ì±„ë„ëª…:</label>
                <input type="text" id="channelName" required>
            </div>
            <div class="form-group">
                <label for="teacherEmail">ì´ë©”ì¼:</label>
                <input type="email" id="teacherEmail" required>
            </div>
            <div class="form-group">
                <label for="teacherPassword">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬):</label>
                <input type="password" id="teacherPassword" maxlength="4" required>
            </div>
            <button type="submit">ì±„ë„ ìƒì„±</button>
          </form>
          <p id="createStatus" style="margin-top: 15px; color: var(--error-color); font-weight: bold;"></p>
        `;
        break;
        
      case 'login_manage_stories':
        html = `
          <h2 class="content-title">ğŸ”’ ì‚¬ì—° ê´€ë¦¬ ë¡œê·¸ì¸</h2>
          <form id="manageLoginForm">
            <div class="form-group">
                <label for="managerPin">ì±„ë„ PIN ë²ˆí˜¸ (6ìë¦¬):</label>
                <input type="text" id="managerPin" maxlength="6" required>
            </div>
            <div class="form-group">
                <label for="managerPassword">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬):</label>
                <input type="password" id="managerPassword" maxlength="4" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸ ë° ëª©ë¡ ë³´ê¸°</button>
          </form>
          <p id="manageLoginStatus" style="margin-top: 15px; color: var(--error-color); font-weight: bold;"></p>
        `;
        break;
      
      case 'login_listen':
        html = `
          <h2 class="content-title">ğŸ”’ ì‚¬ì—° ë“£ê¸° ì±„ë„ (ì—°ê²°)</h2> 
          <form id="manageLoginForm">
            <div class="form-group">
                <label for="managerPin">ì±„ë„ PIN ë²ˆí˜¸ (6ìë¦¬):</label>
                <input type="text" id="managerPin" maxlength="6" required>
            </div>
            <div class="form-group">
                <label for="managerPassword">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬):</label>
                <input type="password" id="managerPassword" maxlength="4" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸ ë° ë“£ê¸° ë©”ë‰´</button>
          </form>
          <p id="manageLoginStatus" style="margin-top: 15px; color: var(--error-color); font-weight: bold;"></p>
        `;
        break;

      case 'manage_stories':
        html = `<h2 class="content-title">âš ï¸ ì˜¤ë¥˜: ì˜ëª»ëœ ì ‘ê·¼</h2>`;
        break;

      case 'list_stories':
        html = `<h2 class="content-title">ğŸ“ [${currentChannelName}] ì‚¬ì—° ëª©ë¡</h2>
                <div id="storyListArea"><p>ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;
        setTimeout(fetchStoriesForManagement, 50);
        break;
      
      case 'qrcode':
        html = `
          <h2 class="content-title">ì ‘ì†ìš© QR ì½”ë“œ</h2>
          <div id="qrCodeContainer">
              <div id="qrcode" class="qr-size"></div>
          </div>
        `;
        setTimeout(generateQrCode, 100); 
        break;

      default:
        html = `
          <h2 class="content-title">âœ¨ ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  âœ¨</h2>
          <p>í•˜ë‹¨ ë‹¤ì´ì–¼ì„ ëˆŒëŸ¬ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”!</p>
          <p>ğŸ“ ì‚¬ì—° ì“°ê¸° : ì‚¬ì—°ì„ ì ê³  ì‹ ì²­ê³¡ê³¼ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.</p>
          <p>ğŸ”‘ ì‚¬ì—° ê´€ë¦¬ : ë¼ë””ì˜¤ë¥¼ ê°œì„¤í•˜ê³  ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”.</p>
        `;
        frequencyDisplay.textContent = 'ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³  - í™˜ì˜í•©ë‹ˆë‹¤!';
    }
    
    mainContent.innerHTML = html; 
    
    // âœ… listen í™”ë©´ ë Œë” ì§í›„ ê¸€ì í† ê¸€ ì—°ê²°
    if (page === 'listen') {
      setTimeout(initFontToggleListeners, 0);
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    if (page === 'write' || page === 'pin_entry') {
        setupStoryFormListeners();
    } else if (page === 'create_channel') {
        document.getElementById('createChannelForm').addEventListener('submit', handleCreateChannel);
    } else if (page === 'login_manage_stories' || page === 'login_listen') { 
        document.getElementById('manageLoginForm').addEventListener('submit', (e) => handleManageLogin(e, page));
    } 
  }

  // --------------------- BACK (ë’¤ë¡œê°€ê¸°) ê¸°ëŠ¥ ---------------------
  function goBack() {
      if (pageHistory.length > 1) {
          pageHistory.pop(); 
          const previousPage = pageHistory[pageHistory.length - 1];
          loadContent(previousPage, true); 
      } else {
          loadContent('welcome', true); 
      }
  }
  
  // --------------------- QR ì½”ë“œ ìƒì„± ---------------------
  function showQrCode() {
      loadContent('qrcode');
      frequencyDisplay.textContent = '[QR CODE] - ì ‘ì† ì£¼íŒŒìˆ˜';
  }
  function generateQrCode() {
      const url = window.location.href.split('#')[0]; 
      const qrcodeElement = document.getElementById('qrcode');
      qrcodeElement.innerHTML = ''; 
      new QRCode(qrcodeElement, {
          text: url,
          width: 135,
          height: 135,
          colorDark : "#000000",
          colorLight : "#ffffff",
          correctLevel : QRCode.CorrectLevel.H
      });
  }

  // --------------------- getChannelTitle ---------------------
  function getChannelTitle(page) {
    switch (page) {
        case 'listen': return 'ON AIR';
        case 'write': return 'ì‚¬ì—° ë³´ë‚´ê¸°';
        case 'manage_menu': 
        case 'create_channel':
        case 'login_manage_stories':
        case 'login_listen':
        case 'manage_stories': 
        case 'list_stories': 
            return 'ê´€ë¦¬ì'; 
        case 'qrcode': return 'QR ì½”ë“œ';
        default: return 'ë¼ë””ì˜¤ëŠ” ì‚¬ì—°ì„ ì‹£ê³ ';
    }
  }

  // --------------------- YouTube ê²€ìƒ‰ ---------------------
  let searchResultsData = [];

  async function handleSearch() {
      const queryInput = document.getElementById('searchQuery');
      const query = queryInput.value.trim();
      const resultsContainer = document.getElementById('searchResults');
      const storyUrlInput = document.getElementById('storyUrl');
      
      if (query.length < 2) {
          resultsContainer.innerHTML = '<li>ê²€ìƒ‰ì–´ë¥¼ ë‘ ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</li>';
          return;
      }
      
      resultsContainer.innerHTML = '<li>ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</li>';
      
      startLoadingAnimation('YouTube ê²€ìƒ‰ ì¤‘');

      const res = await callWorker('searchYoutube', { query: query });

      stopLoadingAnimation();

      if (res.success && res.results.length > 0) {
          searchResultsData = res.results;
          displayResults(res.results);
      } else {
          resultsContainer.innerHTML = `<li>ğŸ› ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. URLì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ê²€ìƒ‰ì–´ë¥¼ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</li>`;
          storyUrlInput.value = '';
      }
  }

  function displayResults(results) {
      const resultsContainer = document.getElementById('searchResults');
      let html = '';
      results.forEach((item, index) => {
          html += `<li onclick="selectSong(${index})">ğŸµ ${item.title}</li>`;
      });
      resultsContainer.innerHTML = html;
  }

  function selectSong(index) {
      const selected = searchResultsData[index];
      const storyUrlInput = document.getElementById('storyUrl');
      const resultsContainer = document.getElementById('searchResults');
      storyUrlInput.value = selected.url;
      resultsContainer.innerHTML = `<li>âœ… ${selected.title} ì„ íƒ ì™„ë£Œ!</li>`;
  }
  
  // --------------------- ì‚¬ì—° ì“°ê¸° - í•€ ê²€ì¦ ---------------------
  function setupStoryFormListeners() {
    const pinForm = document.getElementById('pinForm');
    const storyFormContainer = document.getElementById('writeForm');
    const storyForm = document.getElementById('storyForm');
    
    pinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const pin = document.getElementById('pin').value;
        const channelNameDisplay = document.getElementById('channelNameDisplay');
        const submissionStatus = document.getElementById('submissionStatus');
        
        startLoadingAnimation('PIN ê²€ì¦ ì¤‘');
        submissionStatus.textContent = '';
        
        const res = await callWorker('getChannelInfoByPin', { pin });
        
        stopLoadingAnimation(); 

        if (res.success) {
            currentChannelPin = pin;
            currentChannelName = res.channelName;
            
            pinForm.style.display = 'none';
            storyFormContainer.style.display = 'block';
            
            pageHistory.push('write');
            history.replaceState({ page: 'write' }, null, `#write`);
            frequencyDisplay.textContent = `[${currentChannelName}] ì£¼íŒŒìˆ˜ ì¼ì¹˜! ì‚¬ì—°ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;

            channelNameDisplay.textContent = `[${currentChannelName}]ì— ì‚¬ì—° ë³´ë‚´ê¸°`;

            if (isStorySubmitted) {
                storyForm.style.display = 'none';
                submissionStatus.textContent = 'ì‚¬ì—°ì€ í•œ ë²ˆë§Œ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            } else {
                storyForm.style.display = 'block';
                submissionStatus.textContent = '';
            }
        } else {
            submissionStatus.textContent = `ğŸ› ì˜¤ë¥˜: ${res.message}`;
            currentChannelPin = null;
            currentChannelName = null;
        }
    });

    storyForm.addEventListener('submit', handleStorySubmit);
  }

  // --------------------- ì‚¬ì—° ì œì¶œ ---------------------
  async function handleStorySubmit(e) {
    e.preventDefault();
    if (isStorySubmitted || !currentChannelPin) {
        alert('ì±„ë„ ì¸ì¦ì´ í•„ìš”í•˜ê±°ë‚˜ ì´ë¯¸ ì‚¬ì—°ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ğŸ’¡');
        return;
    }

    const name = document.getElementById('storyName').value;
    const content = document.getElementById('storyContent').value;
    const url = document.getElementById('storyUrl').value;
    const statusDiv = document.getElementById('submissionStatus');
    
    startLoadingAnimation('ì‚¬ì—° ë³´ë‚´ëŠ” ì¤‘');
    statusDiv.textContent = 'ë³´ë‚´ëŠ” ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';

    const res = await callWorker('submitStory', { 
        name: name, 
        content: content, 
        youtubeUrl: url,
        pin: currentChannelPin 
    });
    
    stopLoadingAnimation();

    if (res.success) {
        statusDiv.textContent = 'âœ… ì‚¬ì—°ì´ ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤! (ìŠ¹ì¸ ëŒ€ê¸° ì¤‘)';
        isStorySubmitted = true;
        document.getElementById('storyForm').style.display = 'none';
    } else {
        statusDiv.textContent = `ğŸ› ì˜¤ë¥˜ ë°œìƒ: ${res.message}`;
    }
  }
  
  // --------------------- ì±„ë„ ìƒì„± ---------------------
  async function handleCreateChannel(e) {
      e.preventDefault();
      const channelName = document.getElementById('channelName').value;
      const teacherEmail = document.getElementById('teacherEmail').value;
      const teacherPassword = document.getElementById('teacherPassword').value;
      const createStatus = document.getElementById('createStatus');
      
      const pin = Math.floor(100000 + Math.random() * 900000).toString(); 
      
      startLoadingAnimation('ì±„ë„ ìƒì„± ì¤‘');
      createStatus.textContent = `âœ¨ ì±„ë„ ìƒì„± ì¤‘...`;
      
      const res = await callWorker('createChannel', {
          channelName,
          teacherEmail,
          teacherPassword,
          pin
      });

      stopLoadingAnimation(); 

      if (res.success) {
          showModal(
              `${channelName} ì±„ë„ ìƒì„± ì™„ë£ŒğŸ‰`,
              res.pin, 
              teacherPassword
          );
          createStatus.textContent = '';
      } else {
          createStatus.textContent = `ğŸ› ì±„ë„ ìƒì„± ì˜¤ë¥˜: ${res.message}`;
      }
  }
  
  // --------------------- êµì‚¬ ê´€ë¦¬ ë¡œê·¸ì¸ ---------------------
  async function handleManageLogin(e, loginType) {
      e.preventDefault();
      const pin = document.getElementById('managerPin').value;
      const password = document.getElementById('managerPassword').value;
      const loginStatus = document.getElementById('manageLoginStatus');
      
      startLoadingAnimation('ë¡œê·¸ì¸ ì¤‘');
      loginStatus.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
      
      const authRes = await callWorker('getAllStories', { pin, password }); 
      
      stopLoadingAnimation(); 

      if (authRes.success || (authRes.message && authRes.message.includes('ë„ì°©í•œ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤'))) { 
          const channelInfo = await callWorker('getChannelInfoByPin', { pin });
          if (channelInfo.success) {
            currentChannelName = channelInfo.channelName;
            currentChannelPin = pin; 
            managerPassword = password; 
            loginStatus.textContent = `ë¡œê·¸ì¸ ì„±ê³µ! [${currentChannelName}] ì±„ë„ ì—°ê²° ì™„ë£Œ. ğŸ˜Š`;
            setTimeout(() => {
                if (loginType === 'login_listen') {
                    loadContent('listen');
                } else {
                    loadContent('list_stories');
                }
            }, 500);
          } else {
            loginStatus.textContent = `ì¸ì¦ ì‹¤íŒ¨: ${channelInfo.message}`;
          }
      } else {
          loginStatus.textContent = `ì¸ì¦ ì‹¤íŒ¨: ${authRes.message}`;
      }
  }

  // --------------------- ì‚¬ì—° ê´€ë¦¬ ëª©ë¡ ë° ìŠ¹ì¸ ---------------------
  async function fetchStoriesForManagement() {
      if (!currentChannelPin || !managerPassword) {
          document.getElementById('storyListArea').innerHTML = '<p style="color: red;">ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>';
          return;
      }
      
      const storyListArea = document.getElementById('storyListArea');
      storyListArea.innerHTML = `<p>ì‚¬ì—° ëª©ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
      
      startLoadingAnimation('ì‚¬ì—° ëª©ë¡ ë¡œë“œ ì¤‘'); 

      const res = await callWorker('getAllStories', { 
          pin: currentChannelPin, 
          password: managerPassword 
      });
      
      stopLoadingAnimation(); 

      if (res.success) {
          const stories = res.stories;
          if (stories.length === 0) {
              storyListArea.innerHTML = `<p>ì•„ì§ ë„ì°©í•œ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ“</p>`;
              return;
          }
          
          let tableHtml = `
            <form id="bulkUpdateForm">
            <table class="story-table">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì´ë¦„</th>
                        <th><span title="ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì „ì²´ ë‚´ìš©ì´ ë³´ì…ë‹ˆë‹¤.">ì‚¬ì—° (ì• 15ì)</span></th>
                        <th>URL</th>
                        <th>ìƒíƒœ</th>
                        <th>ìŠ¹ì¸/ê±°ì ˆ</th>
                    </tr>
                </thead>
                <tbody>`;
          
          stories.forEach(story => {
              let statusText = story.status;
              let statusClass;
              if (story.isPlayed) {
                  statusClass = 'status-approved';
                  statusText += ' (ì™„ë£Œ)';
              } else {
                  statusClass = `status-${story.status.toLowerCase()}`;
              }
              
              const contentSnippet = story.content.length > 15 ? story.content.substring(0, 15) + '...' : story.content;
              const formattedDate = new Date(story.timestamp).toLocaleDateString('ko-KR');

              tableHtml += `
                  <tr>
                      <td>${formattedDate}</td>
                      <td>${story.name}</td>
                      <td title="${story.content}" class="story-content-cell">${contentSnippet}</td>
                      <td><a href="${story.youtubeUrl}" target="_blank">ë§í¬</a></td>
                      <td class="${statusClass}">${statusText}</td>
                      <td>
                          <select name="status_${story.rowNum}" data-row="${story.rowNum}" class="status-select">
                              <option value="${story.status}" selected disabled>${story.status}</option>
                              <option value="Approved" ${story.status === 'Approved' ? 'selected' : ''}>ìŠ¹ì¸ (Approved)</option>
                              <option value="Rejected" ${story.status === 'Rejected' ? 'selected' : ''}>ê±°ì ˆ (Rejected)</option>
                              <option value="Pending" ${story.status === 'Pending' ? 'selected' : ''}>ëŒ€ê¸° (Pending)</option>
                          </select>
                      </td>
                  </tr>
              `;
          });

          tableHtml += `</tbody></table>
                      <button type="submit" class="button-group" style="margin-top: 15px; background-color: var(--dark-wood); color: var(--dial-color);">ì¼ê´„ ì €ì¥ (ìƒíƒœ ë³€ê²½)</button>
                      </form>`;
        
        storyListArea.innerHTML = tableHtml;
        document.getElementById('bulkUpdateForm').addEventListener('submit', handleBulkSave);

      } else {
          storyListArea.innerHTML = `<p style="color: red;">ğŸ› ì‚¬ì—° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${res.message}</p>`;
      }
  }
  
  async function handleBulkSave(e) {
      e.preventDefault();
      if (!currentChannelPin || !managerPassword) {
          alert('ì±„ë„ ì¸ì¦ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
      }
      if (!confirm('ë³€ê²½ëœ ìƒíƒœë¥¼ ì„œë²„ì— ì¼ê´„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const form = e.target;
      const selectElements = form.querySelectorAll('.status-select');
      const updates = [];
      let isChanged = false;
      
      selectElements.forEach(select => {
          const initialStatus = select.options[0].value; 
          const newStatus = select.value;
          if (initialStatus !== newStatus) {
              updates.push({
                  rowNum: parseInt(select.dataset.row),
                  newStatus: newStatus
              });
              isChanged = true;
          }
      });
      
      if (!isChanged) {
          alert('ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
      }

      const saveButton = form.querySelector('button[type="submit"]');
      saveButton.textContent = 'ì €ì¥ ì¤‘...';
      saveButton.disabled = true;

      const res = await callWorker('bulkUpdateStories', {
          pin: currentChannelPin,
          password: managerPassword,
          updates: updates
      });
      
      if (res.success) {
          alert(res.message);
      } else {
          alert(`ğŸ› ì¼ê´„ ì €ì¥ ì‹¤íŒ¨: ${res.message}`);
      }
      fetchStoriesForManagement(); 
  }

  async function updateStoryStatus(rowNum, newStatus) {
      if (!confirm(`í–‰ ë²ˆí˜¸ ${rowNum}ì˜ ì‚¬ì—°ì„ '${newStatus}' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      if (!managerPassword) {
         alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì •ë³´ê°€ ìœ ì‹¤ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
         return;
      }
      const res = await callWorker('updateStoryStatus', {
          rowNum, 
          newStatus, 
          pin: currentChannelPin,
          password: managerPassword 
      });

      if (res.success) {
          alert(res.message);
          fetchStoriesForManagement(); 
      } else {
          alert(`ğŸ› ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${res.message}`);
      }
  }

  // --------------------- ì‚¬ì—° ë“£ê¸° ---------------------
  let storyData = [];
  let currentStoryIndex = -1;
  let playMode = 'random';
  let player;

  async function playStories(mode) {
      if (!currentChannelPin) {
          alert('ì±„ë„ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
      }
      playMode = mode;
      
      const playerArea = document.getElementById('mainContent').querySelector('.scroll-text-box #playerArea');
      if (playerArea) {
        playerArea.innerHTML = `<p>ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
      }
      
      startLoadingAnimation('ì‚¬ì—° ë¡œë“œ ì¤‘'); 

      const res = await callWorker('getApprovedStories', { pin: currentChannelPin });
      
      stopLoadingAnimation(); 

      if (res.success) {
          const stories = res.stories; 
          storyData = stories.filter(s => s.youtubeUrl && !s.youtubeUrl.startsWith('Search:'));
          
          if (storyData.length === 0) {
              mainContent.innerHTML = `
                  <h2 class="content-title">ğŸ¶ ì‚¬ì—° ë“£ê¸°</h2>
                  <p>ì½ì„ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤! í•´ë‹¹ ì±„ë„ì€ ë‹¤ìŒ ë‚  ìì • ìë™ ì‚­ì œë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
              `; 
              frequencyDisplay.textContent = 'ëª¨ë“  ì‚¬ì—° ì¬ìƒ ì™„ë£Œ';
              return;
          }

          // ì¬ìƒ í™”ë©´ ë‹¤ì‹œ ë Œë” (í† ê¸€ ë²„íŠ¼ í¬í•¨)
          mainContent.innerHTML = `
              <div class="story-player-area">
                <div class="scroll-text-box">
                    <h2 class="content-title">ğŸ¶ ì‚¬ì—° ë“£ê¸°</h2> 
                    <p id="playerArea" style="margin-top: 10px;">ì¬ìƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                    <div class="story-scroll-container">
                        <p id="scrollingText" class="story-text-scrolling size-small"></p>
                    </div>
                </div>
                
                <div class="youtube-panel">
                    <div class="playback-controls">
                        <button class="icon-button" title="ìˆœì°¨ ì¬ìƒ" onclick="playStories('sequential')">&#9654;</button>
                        <button class="icon-button" title="ëœë¤ ì¬ìƒ" onclick="playStories('random')">&#8644;</button>
                        <div class="font-toggle">
                          <button id="fontSmallBtn" class="font-btn">a</button>
                          <button id="fontLargeBtn" class="font-btn">A</button>
                        </div>
                    </div>

                    <div id="currentStoryInfo"></div>

                    <div class="youtube-box">
                        <div id="youtubePlayer"></div>
                    </div>
                </div>
              </div>
          `;
          
          // í† ê¸€ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ë° í˜„ì¬ ëª¨ë“œ ì ìš©
          setTimeout(() => {
            initFontToggleListeners();
            applyTextSize(false);
          }, 0);

          loadYoutubeAPI();
      } else {
          mainContent.innerHTML = `<p style="color: red;">ğŸ› ì‚¬ì—°ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${res.message}</p>`;
      }
  }

  function loadYoutubeAPI() {
      if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
          const tag = document.createElement('script');
          tag.src = "https://www.youtube.com/iframe_api";
          const firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
      } else {
          onYouTubeIframeAPIReady();
      }
  }

  function onYouTubeIframeAPIReady() {
      const youtubeBox = document.getElementById('youtubePlayer');
      if (!youtubeBox) {
          console.error("YouTube Player DOM element not found.");
          return;
      }

      player = new YT.Player('youtubePlayer', {
          height: '100%',
          width: '100%',
          playerVars: {
              'rel': 0,
              'modestbranding': 1,
              'autoplay': 1,
              'disablekb': 1,
              'iv_load_policy': 3,
              'showinfo': 0,
              'cc_load_policy': 0
          },
          events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange
          }
      });
  }

  function onPlayerReady(event) {
      playNextStory();
  }

  function onPlayerStateChange(event) {
      if (event.data === 0) { // ENDED
          if (currentStoryIndex !== -1 && storyData[currentStoryIndex]) {
              const story = storyData[currentStoryIndex];
              callWorker('setStoryPlayed', { 
                  pin: currentChannelPin, 
                  rowNum: story.rowNum 
              })
              .then(res => {
                  if (res.success) {
                      console.log(`[Playback] Row ${story.rowNum} marked as Played.`);
                      storyData.splice(currentStoryIndex, 1);
                      currentStoryIndex = -1; 
                  } else {
                      console.error(`[Playback Error] Failed to mark Row ${story.rowNum} as Played: ${res.message}`);
                  }
                  playNextStory(); 
              });
          } else {
               playNextStory(); 
          }
      }
      if (event.data === 1) { // STARTED
          if (currentStoryIndex !== -1 && storyData[currentStoryIndex]) {
              const story = storyData[currentStoryIndex];
              const storyInfoElement = document.getElementById('currentStoryInfo');
              if (storyInfoElement) {
                const totalRemaining = storyData.length;
                storyInfoElement.textContent = `${totalRemaining}ê°œ ì‚¬ì—° ì¤‘ ${currentStoryIndex + 1}ë²ˆì§¸`;
              }
              callWorker('setStoryPlayed', { 
                  pin: currentChannelPin, 
                  rowNum: story.rowNum 
              })
              .then(res => {
                  if (res.success) {
                      console.log(`[Playback] Row ${story.rowNum} marked as Played (on start).`);
                  }
              });
          }
      }
  }

  function playNextStory() {
      const storyInfoElement = document.getElementById('currentStoryInfo');
      const totalStories = storyData.length + (currentStoryIndex !== -1 ? 1 : 0);

      if (storyData.length === 0) {
          const playerArea = document.getElementById('playerArea');
          playerArea.innerHTML = `<p>ë” ì½ì„ ì‚¬ì—°ì´ ì—†ìŠµë‹ˆë‹¤! í•´ë‹¹ ì±„ë„ì€ ìë™ ì‚­ì œë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>`;
          frequencyDisplay.textContent = 'ëª¨ë“  ì‚¬ì—° ì¬ìƒ ì™„ë£Œ';
          if (storyInfoElement) storyInfoElement.textContent = `0/${totalStories} ìƒˆ ì‚¬ì—° ì¤‘ 0ë²ˆì§¸`;
          if (player) player.stopVideo();
          return;
      }
      
      let nextIndex;
      if (playMode === 'random') {
          nextIndex = Math.floor(Math.random() * storyData.length);
      } else { // sequential
          nextIndex = (currentStoryIndex + 1);
          if (nextIndex >= storyData.length) nextIndex = 0;
      }
      
      currentStoryIndex = nextIndex;

      const story = storyData[currentStoryIndex];
      const videoId = getYoutubeVideoId(story.youtubeUrl);
      
      if (videoId && player) {
Â  Â  Â  Â  Â  Â  Â  player.loadVideoById(videoId); // ìŒì•… ë¨¼ì € ë¡œë“œ/ì¬ìƒ
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  frequencyDisplay.textContent = `ON AIR: ${story.name} ë‹˜ì˜ ì‚¬ì—° (ì±„ë„: ${currentChannelName})`;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (storyInfoElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalRemaining = storyData.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  storyInfoElement.textContent = `${totalRemaining}ê°œ ì‚¬ì—° ì¤‘ ${currentStoryIndex + 1}ë²ˆì§¸ ì¬ìƒ ì¤‘`;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  const scrollingText = document.getElementById('scrollingText');
Â  Â  Â  Â  Â  Â  Â  // ì¤„ë°”ê¿ˆ ì ìš©: ì œëª© ë¼ì¸ + ë³¸ë¬¸
Â  Â  Â  Â  Â  Â  Â  scrollingText.textContent = `[${story.name} ë‹˜ì˜ ì‚¬ì—°]\n${story.content}`;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // ì• ë‹ˆë©”ì´ì…˜ì„ ì´ˆê¸°í™” (ìˆ¨ê¹€)
Â  Â  Â  Â  Â  Â  Â  scrollingText.style.animation = 'none';
Â  Â  Â  Â  Â  Â  Â  scrollingText.style.top = '100%';
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  // ğŸ› ë³€ê²½: ìœ íŠœë¸Œ ì¬ìƒ í›„ 3ì´ˆ ë’¤ì— ì‚¬ì—° ìŠ¤í¬ë¡¤ ì‹œì‘
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  void scrollingText.offsetWidth; // Reflowë¥¼ ê°•ì œí•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ì„ ë‹¤ì‹œ ì ìš©
Â  Â  Â  Â  Â  Â  Â  Â  Â  scrollingText.style.animation = `scrollUp var(--scrollDur) linear forwards`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  // âœ… í˜„ì¬ ì„ íƒëœ í¬ê¸° ëª¨ë“œ ë°˜ì˜
Â  Â  Â  Â  Â  Â  Â  Â  Â  applyTextSize(false);
Â  Â  Â  Â  Â  Â  Â  }, 3000); // ğŸ‘ˆ 3ì´ˆ (3000ms) ì§€ì—° ì„¤ì •

Â  Â  Â  Â  Â  } else {
          console.error('ìœ íš¨í•˜ì§€ ì•Šì€ YouTube URL ë˜ëŠ” ID: ', story.youtubeUrl);
          storyData.splice(currentStoryIndex, 1);
          currentStoryIndex = -1; 
          playNextStory(); 
      }
  }

  function getYoutubeVideoId(url) {
      if (!url) return null;
      const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|\w+\/|watch\?v=)|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
      return (match && match[1]) ? match[1] : null;
  }

  window.onload = () => {
      loadContent('welcome');
  };
</script>
</body>
</html>
